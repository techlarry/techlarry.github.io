<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        <meta name="author" content="Zhenhua Wang">
        <link rel="canonical" href="http://larryim.cc/note/osc/ch7/">
        <link rel="shortcut icon" href="../../img/favicon.ico">
        <title>Chapter 7: Synchronization Examples - Zhenhua's Notes</title>
        <link href="../../css/bootstrap-custom.min.css" rel="stylesheet">
        <link href="../../css/font-awesome-4.5.0.css" rel="stylesheet">
        <link href="../../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="../../css/highlight.css">
        <link href="../../extra_css/custom.css" rel="stylesheet">
        <link href="../../extra_css/custom.js" rel="stylesheet">
        <link href="../../extra_css/friendly.css" rel="stylesheet">
        <link href="../../extra_css/theme.css" rel="stylesheet">
        <link href="../../extra_css/mkdocs/js/lunr-0.5.7.min.js" rel="stylesheet">
        <link href="../../extra_css/mkdocs/js/mustache.min.js" rel="stylesheet">
        <link href="../../extra_css/mkdocs/js/require.js" rel="stylesheet">
        <link href="../../extra_css/mkdocs/js/search.js" rel="stylesheet">
        <link href="../../extra_css/mkdocs/js/text.js" rel="stylesheet">
        <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->

        <script src="../../js/jquery-1.10.2.min.js"></script>
        <script src="../../js/bootstrap-3.0.3.min.js"></script>
        <script src="../../js/highlight.pack.js"></script> 
    </head>

    <body>

        <div class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">

        <!-- Collapsed navigation -->
        <div class="navbar-header">
            <!-- Expander button -->
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="../..">Zhenhua's Notes</a>
        </div>

        <!-- Expanded navigation -->
        <div class="navbar-collapse collapse">
                <!-- Main navigation -->
                <ul class="nav navbar-nav">
                    <li >
                        <a href="../..">Home</a>
                    </li>
                    <li class="dropdown active">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">OSC <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                            
<li >
    <a href="../">Contents</a>
</li>
                            
<li >
    <a href="../ch1/">Chapter 1: Introduction </a>
</li>
                            
<li >
    <a href="../ch2/">Chapter 2: Operating System structures</a>
</li>
                            
<li >
    <a href="../ch3/">Chapter 3: Processes</a>
</li>
                            
<li >
    <a href="../ch4/">Chapter 4: Threads and Concurrency</a>
</li>
                            
<li >
    <a href="../ch5/">Chapter 5: CPU Scheduling</a>
</li>
                            
<li >
    <a href="../ch6/">Chapter 6: Synchronization Tools</a>
</li>
                            
<li class="active">
    <a href="./">Chapter 7: Synchronization Examples</a>
</li>
                            
<li >
    <a href="../ch8/">Chapter 8: Deadlocks</a>
</li>
                            
<li >
    <a href="../ch9/">Chapter 9: Main Memory</a>
</li>
                            
<li >
    <a href="../ch10/">Chapter 10: Virtual Memory</a>
</li>
                            
<li >
    <a href="../ch11/">Chapter 11: Mass-Storage Structure</a>
</li>
                            
<li >
    <a href="../ch13/">Chapter 13: File-System Interfaces</a>
</li>
                        </ul>
                    </li>
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">CSAPP <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                            
<li >
    <a href="../../csapp/">Contents</a>
</li>
                            
<li >
    <a href="../../csapp/ch1/">Chapter 1: 计算机系统漫游</a>
</li>
                            
<li >
    <a href="../../csapp/ch2/">Chapter 2: 信息的表示和处理</a>
</li>
                            
<li >
    <a href="../../csapp/ch3/">Chapter 3: 程序的机器级表示</a>
</li>
                            
<li >
    <a href="../../csapp/ch4/">Chapter 4: 处理器体系结构</a>
</li>
                            
<li >
    <a href="../../csapp/ch5/">Chapter 5: 优化程序性能</a>
</li>
                            
<li >
    <a href="../../csapp/ch6/">Chapter 6: 存储器层次结构</a>
</li>
                            
<li >
    <a href="../../csapp/ch7/">Chapter 7: 链接</a>
</li>
                            
<li >
    <a href="../../csapp/ch8/">Chapter 8: 异常控制流</a>
</li>
                            
<li >
    <a href="../../csapp/ch9/">Chapter 9: 虚拟内存</a>
</li>
                            
<li >
    <a href="../../csapp/ch10/">Chapter 10: 系统级I/O</a>
</li>
                            
<li >
    <a href="../../csapp/ch11/">Chapter 11: 网络编程</a>
</li>
                        </ul>
                    </li>
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">HFJ <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                            
<li >
    <a href="../../hfj/">Contents</a>
</li>
                            
<li >
    <a href="../../hfj/ch1/">Chapter 1: Dive in A Quick Dip</a>
</li>
                            
<li >
    <a href="../../hfj/ch2/">Chapter 2: Classes and Objects</a>
</li>
                            
<li >
    <a href="../../hfj/ch3/">Chapter 3: Primitives and References</a>
</li>
                            
<li >
    <a href="../../hfj/ch4/">Chapter 4: Methods use Instance Variables</a>
</li>
                            
<li >
    <a href="../../hfj/ch5/">Chapter 5: Writing a Program</a>
</li>
                            
<li >
    <a href="../../hfj/ch6/">Chapter 6: Get to Know the Java API</a>
</li>
                            
<li >
    <a href="../../hfj/ch7/">Chapter 7: Inheritance and Polymorphism</a>
</li>
                            
<li >
    <a href="../../hfj/ch8/">Chapter 8: Interfaces and Abstract Classes</a>
</li>
                            
<li >
    <a href="../../hfj/ch9/">Chapter 9: Constructors and Garbage Collection</a>
</li>
                            
<li >
    <a href="../../hfj/ch10/">Chapter 10: Numbers and Statics</a>
</li>
                            
<li >
    <a href="../../hfj/ch11/">Chapter 11: Exception Handling</a>
</li>
                            
<li >
    <a href="../../hfj/ch12/">Chapter 12: Getting GUI</a>
</li>
                            
<li >
    <a href="../../hfj/ch13/">Chapter 13: Using Swing</a>
</li>
                            
<li >
    <a href="../../hfj/ch14/">Chapter 14: Serialization and File I/O</a>
</li>
                            
<li >
    <a href="../../hfj/ch15/">Chapter 15: Networking and Threads</a>
</li>
                            
<li >
    <a href="../../hfj/ch16/">Chapter 16: Collections and Generics</a>
</li>
                            
<li >
    <a href="../../hfj/ch17/">Chapter 17: Packages, Jars and Deployment</a>
</li>
                            
<li >
    <a href="../../hfj/ch18/">Chapter 18: Remote deploy with RMI</a>
</li>
                        </ul>
                    </li>
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">LKD <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                            
<li >
    <a href="../../lkd/">Contents</a>
</li>
                            
<li >
    <a href="../../lkd/ch1/">Chapter 1 : Introduction to Linux Kernel</a>
</li>
                            
<li >
    <a href="../../lkd/ch2/">Chapter 2</a>
</li>
                            
<li >
    <a href="../../lkd/ch3/">Chapter 3</a>
</li>
                            
<li >
    <a href="../../lkd/ch4/">Chapter 4</a>
</li>
                            
<li >
    <a href="../../lkd/ch5/">Chapter 5</a>
</li>
                            
<li >
    <a href="../../lkd/ch6/">Chapter 6</a>
</li>
                            
<li >
    <a href="../../lkd/ch7/">Chapter 7</a>
</li>
                            
<li >
    <a href="../../lkd/ch8/">Chapter 8</a>
</li>
                            
<li >
    <a href="../../lkd/ch9/">Chapter 9</a>
</li>
                            
<li >
    <a href="../../lkd/ch10/">Chapter 10</a>
</li>
                            
<li >
    <a href="../../lkd/ch11/">Chapter 11</a>
</li>
                            
<li >
    <a href="../../lkd/ch12/">Chapter 12: Memory management</a>
</li>
                            
<li >
    <a href="../../lkd/ch13/">Chapter 13</a>
</li>
                            
<li >
    <a href="../../lkd/ch14/">Chapter 14</a>
</li>
                            
<li >
    <a href="../../lkd/ch15/">Chapter 15</a>
</li>
                            
<li >
    <a href="../../lkd/ch16/">Chapter 16</a>
</li>
                            
<li >
    <a href="../../lkd/ch17/">Chapter 17</a>
</li>
                            
<li >
    <a href="../../lkd/ch18/">Chapter 18</a>
</li>
                            
<li >
    <a href="../../lkd/ch19/">Chapter 19</a>
</li>
                            
<li >
    <a href="../../lkd/ch20/">Chapter 20</a>
</li>
                        </ul>
                    </li>
                    <li >
                        <a href="../../books/">Books</a>
                    </li>
                </ul>

            <ul class="nav navbar-nav navbar-right">
                <li>
                    <a href="#" data-toggle="modal" data-target="#mkdocs_search_modal">
                        <i class="fa fa-search"></i> Search
                    </a>
                </li>
                    <li >
                        <a rel="next" href="../ch6/">
                            <i class="fa fa-arrow-left"></i> Previous
                        </a>
                    </li>
                    <li >
                        <a rel="prev" href="../ch8/">
                            Next <i class="fa fa-arrow-right"></i>
                        </a>
                    </li>
            </ul>
        </div>
    </div>
</div>

        <div class="container">
                <div class="col-md-3"><div class="bs-sidebar hidden-print affix well" role="complementary">
    <ul class="nav bs-sidenav">
        <li class="main active"><a href="#operating-system-concepts-7-synchronization-examples">Operating System Concepts 7 - Synchronization Examples</a></li>
        <li class="main "><a href="#1-classic-problems-of-synchronization">1 Classic Problems of Synchronization</a></li>
            <li><a href="#the-bounded-buffer-problem">The Bounded Buffer Problem</a></li>
            <li><a href="#the-readerswriters-problem">The Readers–Writers Problem</a></li>
            <li><a href="#the-dining-philosophers-problem">The Dining-Philosophers Problem</a></li>
        <li class="main "><a href="#2-synchronization-within-the-linux-kernel">2 Synchronization within the Linux Kernel</a></li>
            <li><a href="#atomic-integer">Atomic integer</a></li>
            <li><a href="#locks">Locks</a></li>
        <li class="main "><a href="#3-posix-synchronization">3 POSIX Synchronization</a></li>
            <li><a href="#posix-mutex-locks">POSIX Mutex Locks</a></li>
            <li><a href="#posix-spinlocks">POSIX Spinlocks</a></li>
            <li><a href="#posix-semaphores">POSIX Semaphores</a></li>
            <li><a href="#posix-condition-variables">POSIX Condition Variables</a></li>
        <li class="main "><a href="#4-synchronization-in-java">4 Synchronization in Java</a></li>
            <li><a href="#java-monitors">Java Monitors</a></li>
            <li><a href="#reentrant-locks">Reentrant Locks</a></li>
            <li><a href="#semaphores">Semaphores</a></li>
            <li><a href="#condition-variables">Condition Variables</a></li>
    </ul>
</div></div>
                <div class="col-md-9" role="main">

<h3 id="operating-system-concepts-7-synchronization-examples"><strong>Operating System Concepts 7 - Synchronization Examples</strong><a class="headerlink" href="#operating-system-concepts-7-synchronization-examples" title="Permanent link">&para;</a></h3>
<h3 id="1-classic-problems-of-synchronization">1 Classic Problems of Synchronization<a class="headerlink" href="#1-classic-problems-of-synchronization" title="Permanent link">&para;</a></h3>
<h4 id="the-bounded-buffer-problem">The Bounded Buffer Problem<a class="headerlink" href="#the-bounded-buffer-problem" title="Permanent link">&para;</a></h4>
<p>We consider the producer-consumer problem with <a href="../ch3/#5-ipc-in-shared-memory-system">bounded buffer</a>. The producer and consumer processes share the following data structures:</p>
<div class="codehilite"><pre><span class="kt">int</span> <span class="n">n</span><span class="p">;</span>
<span class="n">semaphore</span> <span class="n">mutex</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="n">semaphore</span> <span class="n">empty</span> <span class="o">=</span> <span class="n">n</span><span class="p">;</span>
<span class="n">semaphore</span> <span class="n">full</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</pre></div>

<ul>
<li>We assume that the pool consists of <span><span class="MathJax_Preview">n</span><script type="math/tex">n</script></span> buffers, each capable of holding one item.</li>
<li>The <code class="codehilite">mutex</code> binary semaphore provides mutual exclusion for accesses to the buffer pool and is initialized to the value 1.</li>
<li>The <code class="codehilite">empty</code> and <code class="codehilite">full</code> semaphores count the number of empty and full buffers.</li>
</ul>
<div class="codehilite"><pre><span class="c1">// The code for the producer process:</span>
<span class="k">while</span> <span class="p">(</span><span class="nb">true</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">.</span> <span class="p">.</span> <span class="p">.</span>
    <span class="cm">/* produce an item in next produced */</span> 
    <span class="p">.</span> <span class="p">.</span> <span class="p">.</span> 
    <span class="n">wait</span><span class="p">(</span><span class="n">empty</span><span class="p">);</span> 
    <span class="n">wait</span><span class="p">(</span><span class="n">mutex</span><span class="p">);</span> 
    <span class="p">.</span> <span class="p">.</span> <span class="p">.</span>
    <span class="cm">/* add next produced to the buffer */</span> 
    <span class="p">.</span> <span class="p">.</span> <span class="p">.</span> 
    <span class="n">signal</span><span class="p">(</span><span class="n">mutex</span><span class="p">);</span> 
    <span class="n">signal</span><span class="p">(</span><span class="n">full</span><span class="p">);</span>
<span class="p">}</span>


<span class="c1">//The code for the consumer process:</span>
<span class="k">while</span> <span class="p">(</span><span class="nb">true</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">wait</span><span class="p">(</span><span class="n">full</span><span class="p">);</span> 
    <span class="n">wait</span><span class="p">(</span><span class="n">mutex</span><span class="p">);</span>
    <span class="p">.</span> <span class="p">.</span> <span class="p">.</span>
    <span class="cm">/* remove an item from buffer to next consumed */</span>
    <span class="p">.</span> <span class="p">.</span> <span class="p">.</span> 
    <span class="n">signal</span><span class="p">(</span><span class="n">mutex</span><span class="p">);</span> 
    <span class="n">signal</span><span class="p">(</span><span class="n">empty</span><span class="p">);</span>
    <span class="p">.</span> <span class="p">.</span> <span class="p">.</span>
    <span class="cm">/* consume the item in next consumed */</span>
    <span class="p">.</span> <span class="p">.</span> <span class="p">.</span>
<span class="p">}</span>
</pre></div>

<h4 id="the-readerswriters-problem">The Readers–Writers Problem<a class="headerlink" href="#the-readerswriters-problem" title="Permanent link">&para;</a></h4>
<p>Suppose that a database is to be shared among several concurrent processes. </p>
<ul>
<li>Some of these processes may want only to read the database, whereas others may want to update(that is, read and write) the database.</li>
<li>If two readers access the shared data simultaneously, no adverse effects will result.</li>
<li>If a writer and some other processes (either a reader or a writer) access the database simultaneously, chaos may ensue.</li>
</ul>
<p>Three variables are used: <strong><code class="codehilite">mutex</code></strong>, <strong><code class="codehilite">rw_mutex</code></strong>, <strong><code class="codehilite">readcnt</code></strong> to implement solution.</p>
<div class="codehilite"><pre><span class="n">semaphore</span> <span class="n">rw_mutex</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> 
<span class="n">semaphore</span> <span class="n">mutex</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> 
<span class="kt">int</span> <span class="n">read</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</pre></div>

<ul>
<li>semaphore <strong><code class="codehilite">mutex</code></strong>:  used to ensure mutual exclusion when <code class="codehilite">readcnt</code> is updated i.e. when any reader enters or exit from the critical section.</li>
<li>semaphore <strong><code class="codehilite">rw_mutex</code></strong>: used by both readers and writers.</li>
<li>int <strong><code class="codehilite">readcnt</code></strong>: the number of processes performing read in the critical section, initially 0.</li>
</ul>
<p>Writer processes:</p>
<ol>
<li>Writer requests the entry to critical section.</li>
<li>If allowed i.e. <code class="codehilite">wait()</code> gives a true value, it enters and performs the write. If not allowed, it keeps on waiting.</li>
<li>It exits the critical section.</li>
</ol>
<div class="codehilite"><pre><span class="k">do</span> <span class="p">{</span>
    <span class="c1">// writer requests for critical section</span>
    <span class="n">wait</span><span class="p">(</span><span class="n">rw_mutex</span><span class="p">);</span>  

    <span class="c1">// performs the write</span>

    <span class="c1">// leaves the critical section</span>
    <span class="n">signal</span><span class="p">(</span><span class="n">rw_mutex</span><span class="p">);</span>

<span class="p">}</span> <span class="k">while</span><span class="p">(</span><span class="nb">true</span><span class="p">);</span>
</pre></div>

<p>Reader process:</p>
<ol>
<li>Reader requests the entry to critical section.</li>
<li>If allowed:<ul>
<li>It increments the count of number of readers inside the critical section. If this reader is the first reader entering, it locks the <code class="codehilite">rw_mutex</code> semaphore to restrict the entry of writers if any reader is inside.</li>
<li>It then, signals <code class="codehilite">mutex</code> as any other reader is allowed to enter while others are already reading.</li>
<li>After performing reading, it exits the critical section. When exiting, it checks if no more reader is inside, it signals the semaphore <code class="codehilite">rw_mutex</code> as now, writer can enter the critical section.</li>
</ul>
</li>
<li>If not allowed, it keeps on waiting.</li>
</ol>
<div class="codehilite"><pre><span class="k">do</span> <span class="p">{</span>
   <span class="c1">// Reader wants to enter the critical section</span>
   <span class="n">wait</span><span class="p">(</span><span class="n">mutex</span><span class="p">);</span>

   <span class="c1">// The number of readers has now increased by 1</span>
   <span class="n">readcnt</span><span class="o">++</span><span class="p">;</span>                          

   <span class="c1">// there is at least one reader in the critical section</span>
   <span class="c1">// this ensure no writer can enter if there is even one reader</span>
   <span class="c1">// thus we give preference to readers here</span>
   <span class="k">if</span> <span class="p">(</span><span class="n">readcnt</span><span class="o">==</span><span class="mi">1</span><span class="p">)</span>     
      <span class="n">wait</span><span class="p">(</span><span class="n">rw_mutex</span><span class="p">);</span>                    

   <span class="c1">// other readers can enter while this current reader is inside </span>

   <span class="c1">// the critical section</span>
   <span class="n">signal</span><span class="p">(</span><span class="n">mutex</span><span class="p">);</span>                   

        <span class="p">...</span>
   <span class="cm">/* current reader performs reading here */</span>
        <span class="p">...</span>

   <span class="n">wait</span><span class="p">(</span><span class="n">mutex</span><span class="p">);</span>   <span class="c1">// a reader wants to leave</span>

   <span class="n">readcnt</span><span class="o">--</span><span class="p">;</span>

   <span class="c1">// that is, no reader is left in the critical section,</span>
   <span class="k">if</span> <span class="p">(</span><span class="n">readcnt</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> 
       <span class="n">signal</span><span class="p">(</span><span class="n">rw_mutex</span><span class="p">);</span>         <span class="c1">// writers can enter</span>

   <span class="n">signal</span><span class="p">(</span><span class="n">mutex</span><span class="p">);</span> <span class="c1">// reader leaves</span>

<span class="p">}</span> <span class="k">while</span><span class="p">(</span><span class="nb">true</span><span class="p">);</span>
</pre></div>

<h4 id="the-dining-philosophers-problem">The Dining-Philosophers Problem<a class="headerlink" href="#the-dining-philosophers-problem" title="Permanent link">&para;</a></h4>
<p>The dining-philosophers problem is an example of a large class of concurrency-control problems. It is a simple representation of the need to allocate several resources among several processes in a deadlock-free and starvation-free manner.</p>
<p>Consider five philosophers who spend their lives thinking and eating. </p>
<ul>
<li>The philosophers share a circular table surrounded by five chairs, each belonging to one philosopher. </li>
<li>In the center of the table is a bowl of rice, and the table is laid with five single chopsticks.</li>
<li>When a philosopher thinks, she does not interact with her colleagues.</li>
<li>From time to time, a philosopher gets hungry and tries to pick up the two chopsticks that are closest to her (the chopsticks that are between her and her left and right neighbors). </li>
<li>A philosopher may pick up only one chopstick at a time. Obviously, she cannot pick up a chopstick that is already in the hand of a neighbor.</li>
<li>When a hungry philosopher has both her chopsticks at the same time, she eats without releasing the chopsticks. </li>
<li>When she is finished eating, she puts down both chopsticks and starts thinking again</li>
</ul>
<p><img alt="dining_philosophers" src="../figures/dining_philosophers.png" /></p>
<h3 id="2-synchronization-within-the-linux-kernel">2 Synchronization within the Linux Kernel<a class="headerlink" href="#2-synchronization-within-the-linux-kernel" title="Permanent link">&para;</a></h3>
<p>Linux provides several different mechanisms for synchronization in the kernel. </p>
<p>The synchronization methods discussed here to synchronization within the kernel and are therefore available only to kernel developers.</p>
<h4 id="atomic-integer">Atomic integer<a class="headerlink" href="#atomic-integer" title="Permanent link">&para;</a></h4>
<p>The simplest synchronization technique within the Linux kernel is an atomic integer, which is represented using the <em><a href="https://en.wikipedia.org/wiki/Opaque_data_type">opaque data type</a></em> <code class="codehilite">atomic_t</code>. All math operations using atomic integers are performed without interruption.</p>
<p>Atomic integers are particularly efficient in situations where an integer variable—such as a counter—needs to be updated, since atomic operations do not require the overhead of locking mechanisms:</p>
<p><img alt="various_atomic_operations" src="../figures/various_atomic_operations.png" /></p>
<h4 id="locks">Locks<a class="headerlink" href="#locks" title="Permanent link">&para;</a></h4>
<p>In situations where there are several variables contributing to a possible race condition, more sophisticated locking tools must be used. Mutex locks are available in Linux for protecting critical sections within the kernel. Here, a task must invoke the <code class="codehilite">mutex_lock()</code> function prior to entering a critical section and the<code class="codehilite">mutex_unlock()</code> function after exiting the critical section.</p>
<p>Linux also provides spinlocks and semaphores (as well as reader–writer versions of these two locks) for locking in the kernel. </p>
<p>Both spinlocks and mutex locks in the Linux kernel are <strong><em>nonrecursive</em></strong>, which means that if a thread has acquired one of these locks, it cannot acquire the same lock a second time without first releasing the lock. Otherwise, the second attempt at acquiring the lock will block.</p>
<p>Linux provides two simple system calls — <code class="codehilite">preempt_disable()</code> and <code class="codehilite">preempt_enable()</code> —for disabling and enabling kernel preemption.</p>
<h3 id="3-posix-synchronization">3 POSIX Synchronization<a class="headerlink" href="#3-posix-synchronization" title="Permanent link">&para;</a></h3>
<p>The POSIX API is available for programmers at the user level and is not part of any particular operating-system kernel.</p>
<h4 id="posix-mutex-locks">POSIX Mutex Locks<a class="headerlink" href="#posix-mutex-locks" title="Permanent link">&para;</a></h4>
<p>Pthreads uses the <code class="codehilite">pthread_mutex_t</code> data type for mutex locks.</p>
<ul>
<li>A mutex is created with the pthread <code class="codehilite">mutex_init()</code> function.</li>
<li>The mutex is acquired and released with the pthread <code class="codehilite">mutex_lock()</code> and pthread <code class="codehilite">mutex_unlock()</code> functions.</li>
</ul>
<div class="codehilite"><pre><span class="cp">#include</span> <span class="cpf">&lt;pthread.h&gt;</span><span class="cp"></span>
<span class="n">pthread_mutex_t</span> <span class="n">mutex</span><span class="p">;</span> 

<span class="cm">/* create and initialize the mutex lock */</span> 
<span class="n">pthread_mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mutex</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

<span class="cm">/* acquire the mutex lock */</span>
 <span class="n">pthread</span> <span class="nf">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mutex</span><span class="p">);</span> 

<span class="cm">/* critical section */</span> 

<span class="cm">/* release the mutex lock */</span> 
<span class="n">pthread</span> <span class="nf">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mutex</span><span class="p">);</span>
</pre></div>

<h4 id="posix-spinlocks">POSIX Spinlocks<a class="headerlink" href="#posix-spinlocks" title="Permanent link">&para;</a></h4>
<div class="codehilite"><pre><span class="c1">// 初始化自旋锁： 用来申请使用自旋锁所需要的资源并且将它初始化为非锁定状态</span>
<span class="kt">int</span> <span class="nf">pthread_spin_init</span><span class="p">(</span><span class="n">pthread_spinlock_t</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span><span class="p">);</span>
<span class="c1">// 获得一个自旋锁：如果该自旋锁当前没有被其它线程所持有，则调用该函数的线程获得该自旋锁.</span>
<span class="c1">// 否则该函数在获得自旋锁之前不会返回。</span>
<span class="kt">int</span> <span class="nf">pthread_spin_lock</span><span class="p">(</span><span class="n">pthread_spinlock_t</span> <span class="o">*</span><span class="p">);</span>
<span class="c1">//释放指定的自旋锁</span>
<span class="kt">int</span> <span class="nf">pthread_spin_unlock</span><span class="p">(</span><span class="n">pthread_spinlock_t</span> <span class="o">*</span><span class="p">);</span>
<span class="c1">// 销毁一个自旋锁</span>
<span class="kt">int</span> <span class="nf">pthread_spin_destroy</span><span class="p">(</span><span class="n">pthread_spinlock_t</span> <span class="o">*</span><span class="p">);</span>
</pre></div>

<h4 id="posix-semaphores">POSIX Semaphores<a class="headerlink" href="#posix-semaphores" title="Permanent link">&para;</a></h4>
<p>Semaphores are not part of the POSIX standard and instead belong to the POSIX SEM extension. POSIX specifies two types of semaphores - <strong>named</strong> and <strong>unnamed</strong> semaphores.</p>
<p>The advantage of named semaphores is that multiple unrelated processes can easily use a common semaphore as a synchronization mechanism by simply referring to the semaphore’s name.</p>
<p>Both Linux and macOS systems provide POSIX named semaphores.</p>
<div class="codehilite"><pre><span class="cp">#include</span> <span class="cpf">&lt;semaphore.h&gt;</span><span class="cp"></span>
<span class="n">sem_t</span> <span class="o">*</span><span class="n">sem</span><span class="p">;</span>

<span class="cm">/* Create the semaphore and initialize it to 1 * Here, we are naming the semaphore SEM.</span>
<span class="cm">* The O_CREAT flag indicates that the semaphore will be created if it does not already exist.</span>
<span class="cm">* The parameter 0666 indicates that the semaphore has read/write access for other processes.</span>
<span class="cm">* The parameter 1 indicates that the semaphore is initialized to 1.</span>
<span class="cm">*/</span>

<span class="n">sem</span> <span class="o">=</span> <span class="n">sem_open</span><span class="p">(</span><span class="s">&quot;SEM&quot;</span><span class="p">,</span> <span class="n">O_CREAT</span><span class="p">,</span> <span class="mo">0666</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

<span class="cm">/* acquire the semaphore */</span>
<span class="n">sem_wait</span><span class="p">(</span><span class="n">sem</span><span class="p">);</span>

<span class="cm">/* critical section */</span>

<span class="cm">/* release the semaphore */</span>
<span class="n">sem_post</span><span class="p">(</span><span class="n">sem</span><span class="p">);</span>
</pre></div>

<h4 id="posix-condition-variables">POSIX Condition Variables<a class="headerlink" href="#posix-condition-variables" title="Permanent link">&para;</a></h4>
<h3 id="4-synchronization-in-java">4 Synchronization in Java<a class="headerlink" href="#4-synchronization-in-java" title="Permanent link">&para;</a></h3>
<h4 id="java-monitors">Java Monitors<a class="headerlink" href="#java-monitors" title="Permanent link">&para;</a></h4>
<p>Bounded buffer using Java synchronization</p>
<div class="codehilite"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">BoundedBuffer</span><span class="o">&lt;</span><span class="n">E</span><span class="o">&gt;</span>
<span class="o">{</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">BUFFER_SIZE</span> <span class="o">=</span> <span class="mi">5</span><span class="o">;</span>

    <span class="kd">private</span> <span class="kt">int</span> <span class="n">count</span><span class="o">,</span> <span class="n">in</span><span class="o">,</span> <span class="n">out</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">E</span><span class="o">[]</span> <span class="n">buffer</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">BoundedBuffer</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
        <span class="n">in</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
        <span class="n">out</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
        <span class="n">buffer</span> <span class="o">=</span> <span class="o">(</span><span class="n">E</span><span class="o">[])</span> <span class="k">new</span> <span class="n">Object</span><span class="o">[</span><span class="n">BUFFER_SIZE</span><span class="o">];</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">synchronized</span> <span class="kt">void</span> <span class="nf">insert</span><span class="o">(</span><span class="n">E</span> <span class="n">item</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">while</span> <span class="o">(</span><span class="n">count</span> <span class="o">==</span> <span class="n">BUFFER_SIZE</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="n">wait</span><span class="o">();</span>
            <span class="o">}</span>
            <span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="n">ie</span><span class="o">)</span> <span class="o">{</span> <span class="o">}</span>
        <span class="o">}</span>

        <span class="n">buffer</span><span class="o">[</span><span class="n">in</span><span class="o">]</span> <span class="o">=</span> <span class="n">item</span><span class="o">;</span>
        <span class="n">in</span> <span class="o">=</span> <span class="o">(</span><span class="n">in</span> <span class="o">+</span> <span class="mi">1</span><span class="o">)</span> <span class="o">%</span> <span class="n">BUFFER_SIZE</span><span class="o">;</span>
        <span class="n">count</span><span class="o">++;</span>

        <span class="n">notify</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">synchronized</span> <span class="n">E</span> <span class="nf">remove</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">E</span> <span class="n">item</span><span class="o">;</span>

        <span class="k">while</span> <span class="o">(</span><span class="n">count</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="n">wait</span><span class="o">();</span>
            <span class="o">}</span>
            <span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="n">ie</span><span class="o">)</span> <span class="o">{</span> <span class="o">}</span>
        <span class="o">}</span>

        <span class="n">item</span> <span class="o">=</span> <span class="n">buffer</span><span class="o">[</span><span class="n">out</span><span class="o">];</span>
        <span class="n">out</span> <span class="o">=</span> <span class="o">(</span><span class="n">out</span> <span class="o">+</span> <span class="mi">1</span><span class="o">)</span> <span class="o">%</span> <span class="n">BUFFER_SIZE</span><span class="o">;</span>
        <span class="n">count</span><span class="o">--;</span>

        <span class="n">notify</span><span class="o">();</span>

        <span class="k">return</span> <span class="n">item</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>

<h4 id="reentrant-locks">Reentrant Locks<a class="headerlink" href="#reentrant-locks" title="Permanent link">&para;</a></h4>
<h4 id="semaphores">Semaphores<a class="headerlink" href="#semaphores" title="Permanent link">&para;</a></h4>
<h4 id="condition-variables">Condition Variables<a class="headerlink" href="#condition-variables" title="Permanent link">&para;</a></h4>
<p>待续，还没学完JAVA呢</p></div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="http://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script>var base_url = '../..';</script>
        <script src="../../js/base.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML"></script>
        <script src="../../search/require.js"></script>
        <script src="../../search/search.js"></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="Search Modal" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                <h4 class="modal-title" id="exampleModalLabel">Search</h4>
            </div>
            <div class="modal-body">
                <p>
                    From here you can search these documents. Enter
                    your search terms below.
                </p>
                <form role="form">
                    <div class="form-group">
                        <input type="text" class="form-control" placeholder="Search..." id="mkdocs-search-query">
                    </div>
                </form>
                <div id="mkdocs-search-results"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="Keyboard Shortcuts Modal" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                <h4 class="modal-title" id="exampleModalLabel">Keyboard Shortcuts</h4>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td><kbd>&larr;</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td><kbd>&rarr;</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>


    </body>
</html>
