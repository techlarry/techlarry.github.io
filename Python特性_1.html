<!doctype html>
<html class="no-js" lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>
    
  Python特性 - techlarry
  
  </title>
  
  
  <link href="atom.xml" rel="alternate" title="techlarry" type="application/atom+xml">
    <link rel="stylesheet" href="asset/css/foundation.min.css" />
    <link rel="stylesheet" href="asset/css/docs.css" />
    <script src="asset/js/vendor/modernizr.js"></script>
    <script src="asset/js/vendor/jquery.js"></script>
  <script src="asset/highlightjs/highlight.pack.js"></script>
  <link href="asset/highlightjs/styles/github.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script>hljs.initHighlightingOnLoad();</script>
<script type="text/javascript">
  function before_search(){
    var searchVal = 'site:larryim.cc ' + document.getElementById('search_input').value;
    document.getElementById('search_q').value = searchVal;
    return true;
  }
</script>
  </head>
  <body class="antialiased hide-extras">
    
    <div class="marketing off-canvas-wrap" data-offcanvas>
      <div class="inner-wrap">


<nav class="top-bar docs-bar hide-for-small" data-topbar>


  <section class="top-bar-section">
  <div class="row">
      <div style="position: relative;width:100%;"><div style="position: absolute; width:100%;">
        <ul id="main-menu" class="left">
        
        <li id=""><a target="_self" href="index.html">HomePage</a></li>
        
        <li id=""><a target="_self" href="archives.html">Archives</a></li>
        
        <li id=""><a target="_blank" href="wiki">WIKI</a></li>
        
        <li id=""><a target="_self" href="notebook.html">NOTEBOOK</a></li>
        
        <li id=""><a target="_self" href="about.html">About</a></li>
        
        <li id=""><a target="_blank" href="note">NOTE</a></li>
        
        </ul>

        <ul class="right" id="search-wrap">
          <li>
<form target="_blank" onsubmit="return before_search();" action="http://google.com/search" method="get">
    <input type="hidden" id="search_q" name="q" value="" />
    <input tabindex="1" type="search" id="search_input"  placeholder="Search"/>
</form>
</li>
          </ul>
      </div></div>
  </div>
  </section>

</nav>

        <nav class="tab-bar show-for-small">
  <a href="javascript:void(0)" class="left-off-canvas-toggle menu-icon">
    <span> &nbsp; techlarry</span>
  </a>
</nav>

<aside class="left-off-canvas-menu">
      <ul class="off-canvas-list">
        
        <li><a target="_self" href="index.html">HomePage</a></li>
        
        <li><a target="_self" href="archives.html">Archives</a></li>
        
        <li><a target="_blank" href="wiki">WIKI</a></li>
        
        <li><a target="_self" href="notebook.html">NOTEBOOK</a></li>
        
        <li><a target="_self" href="about.html">About</a></li>
        
        <li><a target="_blank" href="note">NOTE</a></li>
        

    <li><label>Categories</label></li>

        
            <li><a href="Leetcode.html">Leetcode</a></li>
        
            <li><a href="programming_language.html">编程语言</a></li>
        
            <li><a href="data_structure_and_algorithm.html">数据结构和算法</a></li>
        
            <li><a href="Python%E7%89%B9%E6%80%A7.html">Python特性</a></li>
        
            <li><a href="%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0.html">机器学习</a></li>
        
            <li><a href="English.html">English</a></li>
        
            <li><a href="Computer%20System.html">Computer System</a></li>
        
            <li><a href="Deep%20Learning.html">Deep Learning</a></li>
        
            <li><a href="Linux%20%E7%B3%BB%E7%BB%9F%E7%BC%96%E7%A8%8B.html">Linux 系统编程</a></li>
        
            <li><a href="%E6%95%B0%E6%8D%AE%E5%BA%93.html">数据库</a></li>
        
            <li><a href="Tensorflow.html">Tensorflow</a></li>
        
            <li><a href="Big%20Data.html">Big Data</a></li>
        
            <li><a href="%E6%96%87%E7%8C%AE%E9%98%85%E8%AF%BB.html">文献阅读</a></li>
        
            <li><a href="Tools.html">Tools</a></li>
         

      </ul>
    </aside>

<a class="exit-off-canvas" href="#"></a>


        <section id="main-content" role="main" class="scroll-container">
        
       

 <script type="text/javascript">
	$(function(){
		$('#menu_item_index').addClass('is_active');
	});
</script>
<div class="row">
	<div class="large-8 medium-8 columns">
		<div class="markdown-body home-categories">
		
			<div class="article">
                <a class="clearlink" href="python_GIL_global_interpreter_lock.html">
                
                  <h1>Python GIL</h1>
                  <div class="a-content">
                      
                      <div class="a-content-text">
                        
                        	<ul>
<li>
<a href="#toc_0">An example</a>
</li>
<li>
<a href="#toc_1">Introduction</a>
<ul>
<li>
<a href="#toc_2">Visualization:</a>
</li>
<li>
<a href="#toc_3">Cooperative Multitasking</a>
</li>
<li>
<a href="#toc_4">Preemptive Multitasking</a>
</li>
</ul>
</li>
<li>
<a href="#toc_5">解决办法</a>
<ul>
<li>
<a href="#toc_6">用<code>multiprocessing</code>替代<code>Thread</code></a>
</li>
<li>
<a href="#toc_7">利用<code>ctypes</code>绕过<code>GIL</code></a>
</li>
</ul>
</li>
<li>
<a href="#toc_8">Reference</a>
</li>
</ul>


<h2 id="toc_0">An example</h2>

<p>In the following Python program, it seems that the program may reach 100% CPU usuage. In fact, it takes only 50% of CPU resources.</p>

<pre><code class="language-python">import threading


# 子线程死循环
def test():
    while True:
        pass


t1 = threading.Thread(target=test)
t1.start()

# 主线程死循环
while True:
    pass
</code></pre>

<h2 id="toc_1">Introduction</h2>

<p>Python全局解释器锁(<code>Global Interpreter Lock</code>)是用于同步线程的一种机制，它使得任何时刻仅有一个线程在执行。上面例子中虽然两个线程是死循环，而且有两个物理CPU内核，但因为 <code>GIL</code>的限制，两个线程只是做着分时切换，总的CPU占用率还略低于50％。</p>

<p><strong>Note: One thread runs Python, while N others sleep or await I/O</strong></p>

<h3 id="toc_2">Visualization:</h3>

<p>All of those red regions indicate times where the operating system has scheduled a Python thread on one of the cores, but it can&#39;t run because the thread on the other core is holding it.</p>

<p><img src="media/15028686628076/15028730462252.png" alt="demo for GIL"/><br/>
<img src="media/15028686628076/15028733300914.png" alt=""/></p>

<h3 id="toc_3">Cooperative Multitasking</h3>

<p>When it begins a task, such as network I/O, that is of long or uncertain duration and does not require running any Python code, a thread relinquishes the <code>GIL</code> so another thread can take it and run Python. This polite conduct is called <code>cooperative multitasking</code>(协同式多任务处理), and it allows concurrency; many threads can wait for different events at the same time.</p>

<p>For <code>cooperative multitasking</code>, processes voluntarily yield control periodically or when idle in order to enable multiple applications to be run simultaneously. All programs must cooperate for the entire scheduling scheme to work.</p>

<p>Say that two threads each connect a <code>socket</code>:</p>

<pre><code class="language-python">def do_connect():
    s = socket.socket()
    s.connect((&#39;python.org&#39;, 80))  # drop the GIL

for i in range(2):
    t = threading.Thread(target=do_connect)
    t.start()
</code></pre>

<p>Only one of these two threads can execute Python at a time, but once the thread has begun connecting, it drops the GIL so the other thread can run. This means that both threads could be waiting for their sockets to connect concurrently, which is a good thing. They can do more work in the same amount of time.</p>

<p>Let&#39;s try to open the box and see how a Python thread actually drops the GIL while it waits for a connection to be established, in <code>socketmodule.c</code>:</p>

<pre><code class="language-c">/* s.connect((host, port)) method */
static PyObject *
sock_connect(PySocketSockObject *s, PyObject *addro)
{
    sock_addr_t addrbuf;
    int addrlen;
    int res;

    /* convert (host, port) tuple to C address */
    getsockaddrarg(s, addro, SAS2SA(&amp;addrbuf), &amp;addrlen);

    Py_BEGIN_ALLOW_THREADS
    res = connect(s-&gt;sock_fd, addr, addrlen);
    Py_END_ALLOW_THREADS

    /* error handling and so on .... */
}
</code></pre>

<p>The <code>Py_BEGIN_ALLOW_THREADS</code> macro is where the thread drops the <code>GIL</code>; it is defined simply as:</p>

<pre><code class="language-text">PyThread_release_lock(interpreter_lock);
</code></pre>

<p>And of course <code>Py_END_ALLOW_THREADS</code> reacquires the lock. A thread might block at this spot, waiting for another thread to release the lock; once that happens, the waiting thread grabs the GIL back and resumes executing your Python code. In short: While N threads are blocked on network I/O or waiting to reacquire the <code>GIL</code>, one thread can run Python.</p>

<p>Let&#39;s contrast cooperative multitasking with the other kind of multitasking.</p>

<h3 id="toc_4">Preemptive Multitasking</h3>

<p>A Python thread can voluntarily release the <code>GIL,</code> but it can also have the GIL seized from it preemptively(<code>Preemptive multitasking</code>, 抢占式多任务处理).</p>

<p>Let&#39;s back up and talk about how Python is executed. Your program is run in two stages. First, your Python program is compiled into a simpler binary format called <code>bytecode</code>. Second, the Python interpreter&#39;s main loop, a function mellifluously named <code>PyEval_EvalFrameEx()</code>, reads the <code>bytecode</code> and executes the instructions in it one by one.</p>

<p>While the interpreter steps through your<code>bytecode</code> it periodically drops the <code>GIL</code>, without asking permission of the thread whose code it is executing, so other threads can run:</p>

<pre><code class="language-c">for (;;) {
    if (--ticker &lt; 0) {
        ticker = check_interval;
    
        /* Give another thread a chance */
        PyThread_release_lock(interpreter_lock);
    
        /* Other threads may run now */
    
        PyThread_acquire_lock(interpreter_lock, 1);
    }

    bytecode = *next_instr++;
    switch (bytecode) {
        /* execute the next instruction ... */ 
    }
}
</code></pre>

<p>By default the check interval is 1000 <code>bytecodes</code>. All threads run this same code and have the lock taken from them periodically in the same way. In Python 3 the GIL&#39;s implementation is more complex, and the check interval is not a fixed number of <code>bytecodes</code>, but 15 milliseconds. For your code, however, these differences are not significant.</p>

<h2 id="toc_5">解决办法</h2>

<h3 id="toc_6">用<code>multiprocessing</code>替代<code>Thread</code></h3>

<p>利用<code>multiprocessing</code>模块，可以很方便的处理。但进程会增加程序实现时线程间数据通讯和同步的困难。</p>

<h3 id="toc_7">利用<code>ctypes</code>绕过<code>GIL</code></h3>

<p><code>ctypes</code>可以让Python 接调用任意的C动态库的导出函数。</p>

<pre><code class="language-python">from ctypes import *
from threading import Thread

#加载动态库
lib = cdll.LoadLibrary(&quot;./libdeadloop.so&quot;)

#创建一个子线程，让其执行ｃ语言编写的函数，此函数是一个死循环
t = Thread(target=lib.DeadLoop)
t.start()

#主线程，也调用ｃ语言编写的那个死循环函数
#lib.DeadLoop()

while True:
    pass
</code></pre>

<h2 id="toc_8">Reference</h2>

<ul>
<li><a href="https://opensource.com/article/17/4/grok-gil">Grok the GIL: How to write fast and thread-safe Python</a></li>
<li><a href="http://www.dabeaz.com/GIL/">Understanding the Python GIL, David Beazley</a></li>
<li><a href="https://en.wikipedia.org/wiki/Cooperative_multitasking">Cooperative multitasking WEKIPEDIA</a></li>
</ul>

                        
                      </div>
                  </div>
                </a>
                <div class="read-more clearfix">
                  <div class="more-left left">
                  
                    <span class="date">2017/8/16</span>
                    <span>posted in&nbsp;</span> 
          				  
          					    <span class="posted-in"><a href='Python%E7%89%B9%E6%80%A7.html'>Python特性</a></span>
          				   
                  </div>
                  <div class="more-right right">
                  <span class="comments">
                      

                       
                  </span>
                  </div>
                </div>
              </div><!-- article -->
        
			<div class="article">
                <a class="clearlink" href="python_generator.html">
                
                  <h1>Generator</h1>
                  <div class="a-content">
                      
                      <div class="a-content-text">
                        
                        	<p>Any function that contains a <code>yield</code> statement is called a <code>generator</code>.</p>

<h3 id="toc_0">yield statement</h3>

<p>Each time a value is yielded (with <code>yield</code>), the function freezes; that is, it stops its execution at exactly that point and waits to be reawakened.</p>

<h3 id="toc_1">generator comprehension</h3>

<p><code>Generator comprehension</code> works in the same way as <code>list comprehension</code>, except that a list isn&#39;t constructed. Instead, a <code>generator</code> is returned.</p>

<pre><code class="language-python">&gt;&gt;&gt; h = (i for i in range(10))
&gt;&gt;&gt; h
&lt;generator object &lt;genexpr&gt; at 0x104d76ba0&gt;
&gt;&gt;&gt; list(h)
[0, 1, 2, 3, 4, 5, 6, 7, 8, 9]
</code></pre>

<p>When using <code>generator comprehension</code>, if there already exists parentheses, you don&#39;t need to add another pair.</p>

<pre><code class="language-python">&gt;&gt;&gt; sorted(100-i for i in range(10))
[91, 92, 93, 94, 95, 96, 97, 98, 99, 100]
</code></pre>

<h3 id="toc_2">Recursive generator</h3>

<p><code>generators</code> are ideal for complex recursive algorithms that gradually build a result. </p>

<p>A <code>recursive generator</code> could be used to flatten a nested list.</p>

<pre><code class="language-python">def flatten(nested):
    &quot;&quot;&quot;
    When flatten is called, you have two possibilites: the base case and the recursive case.

    In the base case, the function is told to flatten a single element.
    In the recursive case, flatten it.

    &gt;&gt;&gt; list(flatten([[[1], 2], 3, 4, [5, [6, 7]], 8]))
    [1, 2, 3, 4, 5, 6, 7, 8]
    &gt;&gt;&gt; list(flatten([&#39;foo&#39;, [&#39;bar&#39;, [&#39;baz&#39;]]]))
    [&#39;foo&#39;, &#39;bar&#39;, &#39;baz&#39;]
    &quot;&quot;&quot;
    try:
        try:
            nested + &#39; &#39;
        except TypeError:
            pass
        else:
            raise TypeError
        
        for sublist in nested:
            for element in flatten(sublist):
                yield element

    except TypeError:
        yield nested


if __name__ == &quot;__main__&quot;:
    import doctest
    doctest.testmod(verbose=True)
</code></pre>

<p>An <code>inorder traversal</code> (also <code>postoder traversal</code> and <code>preorder traversal</code>) of a <code>binary search tree</code> might use the <code>recursive generator</code>, detailed code here <a href="http://larryim.cc/binary_search_tree.html">Binary Search Tree</a></p>

<h3 id="toc_3">Generator methods</h3>

<p>We may supply generators with values after they have started running, by using a communications channel between the <code>generator</code> and the “outside world,” with the following two end points:</p>

<ul>
<li><p>The outside world has access to a method on the generator called <code>send</code>, which works just like <code>next</code>, except that it takes a single argument (the “message” to send—an arbitrary object).</p></li>
<li><p>Inside the suspended generator, <strong><code>yield</code> may now be used as an <code>expression</code>, rather than a <code>statement</code></strong>. In other words, when the generator is resumed, yield returns a value—the value sent from the outside through <code>send</code>. If <code>next</code> was used, <code>yield</code> returns <code>None</code>.</p></li>
</ul>

                        
                      </div>
                  </div>
                </a>
                <div class="read-more clearfix">
                  <div class="more-left left">
                  
                    <span class="date">2017/7/23</span>
                    <span>posted in&nbsp;</span> 
          				  
          					    <span class="posted-in"><a href='Python%E7%89%B9%E6%80%A7.html'>Python特性</a></span>
          				   
                  </div>
                  <div class="more-right right">
                  <span class="comments">
                      

                       
                  </span>
                  </div>
                </div>
              </div><!-- article -->
        
			<div class="article">
                <a class="clearlink" href="python_iterator.html">
                
                  <h1>Iterators</h1>
                  <div class="a-content">
                      
                      <div class="a-content-text">
                        
                        	<p>An object that implements the <code>__iter__</code> method is <code>iterable</code>, and the object implementing <code>next</code> is the <code>iterator</code>.</p>

<p>Why Iterator?<br/>
<strong>not overkill, and more general, simpler, elegant</strong></p>

<p>It is recommended that iterators implement an <code>__iter__</code>method of their own in addition (returning self), so they themselves can be used directly in <code>for</code> loops.</p>

<p>Here an example of Fibonacci numbers.</p>

<pre><code class="language-python">
class Fibs:
    &quot;&quot;&quot;
    Fibonacci numbers
    &quot;&quot;&quot;

    def __init__(self):
        self.a = 0
        self.b = 1

    def __next__(self):
        self.a, self.b = self.b, self.a + self.b
        if self.a &gt; 1000:
            raise StopIteration
        return self.a

    def __iter__(self):
        return self

if __name__ == &quot;__main__&quot;:
    fibs = Fibs()
    for f in fibs:
        print(f)
</code></pre>

<h3 id="toc_0">iterable to iterator</h3>

<p>The built-in function <code>iter</code> can be used to get an iterator from an <code>iterable</code> object.</p>

<pre><code class="language-python">&gt;&gt;&gt; iterable = [1,2,3]
&gt;&gt;&gt; iterator = iter(iterable)
&gt;&gt;&gt; next(iterator)
1
</code></pre>

<h3 id="toc_1">iterator to sequence</h3>

<p>Using the <code>list</code> constructor, an iterator can be easily converted to a sequence.</p>

<hr/>

<pre><code class="language-python">&gt;&gt;&gt; h = Fibs
&gt;&gt;&gt; h = Fibs()
&gt;&gt;&gt; list(h)
[1, 1, 2, 3, 5, 8, 13, 21, 34, 55, 89, 144, 233, 377, 610, 987]
</code></pre>

                        
                      </div>
                  </div>
                </a>
                <div class="read-more clearfix">
                  <div class="more-left left">
                  
                    <span class="date">2017/7/23</span>
                    <span>posted in&nbsp;</span> 
          				  
          					    <span class="posted-in"><a href='Python%E7%89%B9%E6%80%A7.html'>Python特性</a></span>
          				   
                  </div>
                  <div class="more-right right">
                  <span class="comments">
                      

                       
                  </span>
                  </div>
                </div>
              </div><!-- article -->
        
			<div class="article">
                <a class="clearlink" href="testing.html">
                
                  <h1>Testing</h1>
                  <div class="a-content">
                      
                      <div class="a-content-text">
                        
                        	<p><a href="https://en.wikipedia.org/wiki/Unit_testing">Unit testing</a> is a software testing method by which individual units of source code, sets of one or more computer program modules together with associated control data, usage procedures, and operating procedures, are tested to determine whether they are fit for use.</p>

<h2 id="toc_0">Test-driven programming</h2>

<p>&quot;<strong>Test first and code later</strong>&quot; practice, known as test-driven programming, instead of test after code.</p>

<h3 id="toc_1">Requirement Specification</h3>

<p>When developing a piece of software, you must first know what problem the software will solve—what objectives it will meet. You can clarify your goals for the program by writing a <strong>requirement specification</strong>, a document (or just some quick notes) describing requirements the program must satisfy. </p>

<h3 id="toc_2">The 1-2-3-4 of Testing</h3>

<p>Here’s a breakdown of the test-driven development process:</p>

<ul>
<li>Figure out the new feature you want. Possibly document it, and then write a test for it.</li>
<li>Write some skeleton code for the feature, so that you program runs without any syntax errors. See your test fail.</li>
<li>Write dummy code for skeleton code, just to appease the test.</li>
<li>Rewrite the code so that it actually pass the test.</li>
</ul>

<h2 id="toc_3">Testing Tools</h2>

<p>Two brilliant modules are available to automate the testing process:</p>

<ul>
<li><code>unittest</code>: A generic testing framework.</li>
<li><code>doctest</code>: A simpler module, designed for checking documentation, but excellent for writing unit tests as well.</li>
</ul>

<h3 id="toc_4">doctest</h3>

<p>The <code>testmod</code> function checks both the module docstring and function docstring.</p>

<p>E.g.</p>

<pre><code class="language-python">def square(x):
    &quot;&quot;&quot;
    squares a number and returns the result.
    &gt;&gt;&gt; square(2)
    4
    &gt;&gt;&gt; square(3)
    9
    &quot;&quot;&quot;
    return x*x

if __name__ == &quot;__main__&quot;:
    import doctest, doc_test_example
    doctest.testmod(doc_test_example, verbose=True)
</code></pre>

<p>Run the example. To get some more output, just add <code>-v</code>(for verbose)</p>

<pre><code class="language-bash">$ python doc_test_example.py -v
Trying:
    square(2)
Expecting:
    4
ok
Trying:
    square(3)
Expecting:
    9
ok
1 items had no tests:
    doc_test_example
1 items passed all tests:
   2 tests in doc_test_example.square
2 tests in 2 items.
2 passed and 0 failed.
Test passed.
</code></pre>

<h3 id="toc_5">unittest</h3>

<p><code>unittest</code> which is based on the popular test framework <code>JUnit</code>, is more flexible and powerful. It allows to write very large and thorough test sets in a more structured manner.</p>

<p><strong>注意： 测试方法应该以test为前缀命名</strong></p>

<p>E.g.</p>

<pre><code class="language-python">import unittest
import doc_test_example as my_math

class ProductTestCase(unittest.TestCase):

    def testIntegers(self):
        for x in xrange(-10,10):
            p = my_math.square(x)
            self.failUnless(p == x*x, &#39;Integer multiplication failed&#39;)

    def testFloats(self):
        for x in xrange(-10,10):
            x = x/10.0
            p = my_math.square(x)
            self.failUnless(p == x*x, &#39;Float multiplication failed&#39;)


if __name__ == &quot;__main__&quot;:
    unittest.main()
</code></pre>

<p>Another example to test <code>dijkstra&#39;s algorithm</code> see <a href="http://larryim.cc/dijkstra_algorithm.html">here</a></p>

<p>Methods such as <code>failUnless</code> check a condition to determine whether the given test succeeds or fails. </p>

<p>The <code>unittest</code> module distinguishes between <code>errors</code>, where an exception is raised, and <code>failures</code>, which result from calls to <code>failUnless</code> and the like. </p>

<h2 id="toc_6">Source Code Checking</h2>

<p><a href="https://www.pylint.org">Pylint</a> and PyChecker are good tools for checking Python source code, looking for mistakes.</p>

<p><code>Pylint</code> is a tool that checks for errors in Python code, tries to enforce a coding standard and looks for code smells. It can also look for certain type errors, it can recommend suggestions about how particular blocks can be refactored and can offer you details about the code’s complexity.</p>

<p><code>Pylint</code> can be integrated with <code>Pycharm</code>, see <a href="https://pylint.readthedocs.io/en/latest/user_guide/ide-integration.html#pylint-in-pycharm">detail</a>.</p>

<h3 id="toc_7">Resources</h3>

<ul>
<li><a href="https://www.ibm.com/developerworks/cn/linux/l-cn-pylint/index.html">如何使用 Pylint 来规范 Python 代码风格</a></li>
<li><a href="https://www.python.org/dev/peps/pep-0008/">Style Guide for Python Code</a></li>
</ul>

<h2 id="toc_8">Profile</h2>

<p><strong>When in doubt, use brute force</strong></p>

<p>The standard library includes nice profiler modules called <code>profile</code> and <code>cProfile</code>.  </p>

<p>A <code>profile</code> is a set of statistics that describes how often and for how long various parts of the program executed. </p>

<pre><code class="language-python">&gt;&gt;&gt; import profile
&gt;&gt;&gt; from my_math import square
&gt;&gt;&gt; profile.run(&#39;square(1, 2)&#39;)
</code></pre>

<p>Another way to use <code>profile</code> in command-line:</p>

<pre><code class="language-bash">$ python -m profile prof1py
</code></pre>

<p>The standard library also contains a module called <code>timeit</code>, which is a simple way of timing small snippets of Python code.</p>

                        
                      </div>
                  </div>
                </a>
                <div class="read-more clearfix">
                  <div class="more-left left">
                  
                    <span class="date">2017/7/14</span>
                    <span>posted in&nbsp;</span> 
          				  
          					    <span class="posted-in"><a href='Python%E7%89%B9%E6%80%A7.html'>Python特性</a></span>
          				   
                  </div>
                  <div class="more-right right">
                  <span class="comments">
                      

                       
                  </span>
                  </div>
                </div>
              </div><!-- article -->
        
			<div class="article">
                <a class="clearlink" href="magic_method_item_access.html">
                
                  <h1>Magic Methods: Item Access</h1>
                  <div class="a-content">
                      
                      <div class="a-content-text">
                        
                        	<p>Useful magic methods allows you to create objects that behave like sequences or mappings.</p>

<h2 id="toc_0">Sequence and Mapping Protocol</h2>

<p><code>protocol</code> in Python usually describe the rules governing some form of behavior. The <code>protocol</code> states which methods you should implement and what those methods should do. So, to be a sequence means,  to follow the sequence protocol.</p>

<ul>
<li><code>__len__(self)</code>: This method should return the number of items contained in the collection. For a sequence, this would simply be the number of elements. For a mapping, it would be the number of key-value pairs. If <code>__len__</code> returns zero (and you don’t implement <code>__nonzero__</code>, which overrides this behavior), the object is treated as false in a Boolean context (as with empty lists, tuples, strings, and dictionaries).</li>
<li><code>__getitem__(self, key)</code>: This should return the value corresponding to the given key. For a sequence, the key should be an integer from \(0\) to \(n–1\) (or, it could be negative, as noted later), where \(n\) is the length of the sequence. For a mapping, you could really have any kind of keys.</li>
<li><code>__setitem__(self, key, value)</code>: This should store value in a manner associated with key, so it can later be retrieved with <code>__getitem__</code>. Of course, you define this method only for mutable objects.</li>
<li><code>__delitem__(self, key)</code>: This is called when someone uses the <code>del</code> statement on a part of the object, and should delete the element associated with key. Again, only mutable objects (and not all of them—only those for which you want to let items be removed) should define this method.</li>
</ul>

<h2 id="toc_1">Example</h2>

<pre><code class="language-python">def checkIndex(key):
    &quot;&quot;&quot;
    Is the given key an acceptable index?
    To be acceptable, the key should be a non-negative integer. If it
    is not an integer, a TypeError is raised; if it is negative, an
    IndexError is raised (since the sequence is of infinite length).
    &quot;&quot;&quot;
    if not isinstance(key, int):
        raise TypeError
    if key &lt; 0:
        raise IndexError


class ArithmeticSequence:
    def __init__(self, start=0, step=1):
        &quot;&quot;&quot;
        Initialize the arithmetic sequence.
        start   - the first value in the sequence
        step    - the difference between two adjacent values
        changed - a dictionary of values that have been modified by the user
        &quot;&quot;&quot;
        self.start = start
        self.step = step
        self.changed = {}

    def __getitem__(self, key):
        &quot;&quot;&quot;
        Get an item from the arithmetic sequence.
        &quot;&quot;&quot;
        checkIndex(key)
        try:
            return self.changed[key]
        except KeyError:
            return self.start + key*self.step
    # Store the start value
    # Store the step value
    # No items have been modified
    # Modified?
    # otherwise...
    # ...calculate the value

    def __setitem__(self, key, value):
        &quot;&quot;&quot;
        Change an item in the arithmetic sequence.
        &quot;&quot;&quot;
        checkIndex(key)
        self.changed[key] = value                 # Store the changed value

    def __delitem__(self, key):
        &quot;&quot;&quot;
        Delete the key provided from sequence
        &quot;&quot;&quot;
        checkIndex(key)
        del self.changed[key]



if __name__ == &quot;__main__&quot;:
    s = ArithmeticSequence(1, 2)
    print(s[4])
    s[4]=3
    print(s[4])
    del s[4]
    print(s[4])
</code></pre>

                        
                      </div>
                  </div>
                </a>
                <div class="read-more clearfix">
                  <div class="more-left left">
                  
                    <span class="date">2017/7/18</span>
                    <span>posted in&nbsp;</span> 
          				  
          					    <span class="posted-in"><a href='Python%E7%89%B9%E6%80%A7.html'>Python特性</a></span>
          				   
                  </div>
                  <div class="more-right right">
                  <span class="comments">
                      

                       
                  </span>
                  </div>
                </div>
              </div><!-- article -->
        
              


			<div class="row">
			  <div class="large-6 columns">
			  <p class="text-left" style="padding-top:25px;">
			   <a href="Python特性.html">&laquo; Prev Page</a>  
			  </p>
			  </div>
			  <div class="large-6 columns">
			<p class="text-right" style="padding-top:25px;">
			 <a href="Python特性_2.html">&raquo; Next Page</a> 
			</p>
			  </div>
			</div>
		</div>
	</div><!-- large 8 -->

 <div class="large-4 medium-4 columns">
  <div class="hide-for-small">
    <div id="sidebar" class="sidebar">
          <div id="site-info" class="site-info">
            
                <div class="site-a-logo"><img src="http://or9a8nskt.bkt.clouddn.com/figure.jpeg" /></div>
            
                <h1>techlarry</h1>
                <div class="site-des">他山之石，可以攻玉</div>
                <div class="social">









<a target="_blank" class="github" target="_blank" href="https://github.com/techlarry" title="GitHub">GitHub</a>
<a target="_blank" class="email" href="mailto:wang.zhen.hua.larry@gmail.com" title="Email">Email</a>
  <a target="_blank" class="rss" href="atom.xml" title="RSS">RSS</a>
                
              	 </div>
          	</div>

             

              <div id="site-categories" class="side-item ">
                <div class="side-header">
                  <h2>Categories</h2>
                </div>
                <div class="side-content">

      	<p class="cat-list">
        
            <a href="Leetcode.html"><strong>Leetcode</strong></a>
        
            <a href="programming_language.html"><strong>编程语言</strong></a>
        
            <a href="data_structure_and_algorithm.html"><strong>数据结构和算法</strong></a>
        
            <a href="Python%E7%89%B9%E6%80%A7.html"><strong>Python特性</strong></a>
        
            <a href="%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0.html"><strong>机器学习</strong></a>
        
            <a href="English.html"><strong>English</strong></a>
        
            <a href="Computer%20System.html"><strong>Computer System</strong></a>
        
            <a href="Deep%20Learning.html"><strong>Deep Learning</strong></a>
        
            <a href="Linux%20%E7%B3%BB%E7%BB%9F%E7%BC%96%E7%A8%8B.html"><strong>Linux 系统编程</strong></a>
        
            <a href="%E6%95%B0%E6%8D%AE%E5%BA%93.html"><strong>数据库</strong></a>
        
            <a href="Tensorflow.html"><strong>Tensorflow</strong></a>
        
            <a href="Big%20Data.html"><strong>Big Data</strong></a>
        
            <a href="%E6%96%87%E7%8C%AE%E9%98%85%E8%AF%BB.html"><strong>文献阅读</strong></a>
        
            <a href="Tools.html"><strong>Tools</strong></a>
         
        </p>


                </div>
              </div>

              <div id="site-categories" class="side-item">
                <div class="side-header">
                  <h2>Recent Posts</h2>
                </div>
                <div class="side-content">
                <ul class="posts-list">
	      
		      
			      <li class="post">
			        <a href="15046649572570.html">Pandas</a>
			      </li>
		     
		  
		      
			      <li class="post">
			        <a href="exceptional_control_flow.html">CSAPP - 异常控制流</a>
			      </li>
		     
		  
		      
			      <li class="post">
			        <a href="introduction_to_computer_system_CMU.html">CMU 15-213 Introduction to Computer Systems</a>
			      </li>
		     
		  
		      
			      <li class="post">
			        <a href="os-concepts-os-structures.html">Operating System Concepts 2 - Operating System structures</a>
			      </li>
		     
		  
		      
			      <li class="post">
			        <a href="os-concets-processes.html">Operating System Concepts 3 - Processes</a>
			      </li>
		     
		  
		      
		  
		      
		  
		      
		  
		      
		  
		      
		  
		      
		  
		      
		  
		      
		  
		      
		  
		      
		  
		      
		  
		      
		  
		      
		  
		      
		  
		      
		   
		  		</ul>
                </div>
              </div>
        </div><!-- sidebar -->
      </div><!-- hide for small -->
</div><!-- large 4 -->

</div><!-- row -->

 <div class="page-bottom clearfix">
  <div class="row">
   <p class="copyright">Copyright &copy; 2015
Powered by <a target="_blank" href="http://www.mweb.im">MWeb</a>,&nbsp; 
Theme used <a target="_blank" href="http://github.com">GitHub CSS</a>.</p>
  </div>
</div>

        </section>
      </div>
    </div>

  
    

    <script src="asset/js/foundation.min.js"></script>
    <script>
      $(document).foundation();
      function fixSidebarHeight(){
        var w1 = $('.markdown-body').height();
          var w2 = $('#sidebar').height();
          if (w1 > w2) { $('#sidebar').height(w1); };
      }
      $(function(){
        fixSidebarHeight();
      })
      $(window).load(function(){
          fixSidebarHeight();
      });
     
    </script>

    
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><script type="text/x-mathjax-config">MathJax.Hub.Config({TeX: { equationNumbers: { autoNumber: "AMS" } }});</script>


  </body>
</html>
