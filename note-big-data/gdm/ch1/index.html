<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        <meta name="author" content="Zhenhua Wang">
        <link rel="canonical" href="http://larryim.cc/note-big-data/gdm/ch1/">
        <link rel="shortcut icon" href="../../img/favicon.ico">
        <title>Chapter 1: 推荐系统入门 - Zhenhua's Notes - Big Data</title>
        <link href="../../css/bootstrap-custom.min.css" rel="stylesheet">
        <link href="../../css/font-awesome.min.css" rel="stylesheet">
        <link href="../../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/docco.min.css">
        <link href="../../extra_css/custom.css" rel="stylesheet">
        <link href="../../extra_css/custom.js" rel="stylesheet">
        <link href="../../extra_css/friendly.css" rel="stylesheet">
        <link href="../../extra_css/theme.css" rel="stylesheet">
        <link href="../../extra_css/mkdocs/js/lunr-0.5.7.min.js" rel="stylesheet">
        <link href="../../extra_css/mkdocs/js/mustache.min.js" rel="stylesheet">
        <link href="../../extra_css/mkdocs/js/require.js" rel="stylesheet">
        <link href="../../extra_css/mkdocs/js/search.js" rel="stylesheet">
        <link href="../../extra_css/mkdocs/js/text.js" rel="stylesheet">
        <link href="../../extra_css/code-tab.css" rel="stylesheet">
        <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
        <![endif]-->

        <script src="../../js/jquery-1.10.2.min.js" defer></script>
        <script src="../../js/bootstrap-3.0.3.min.js" defer></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
        <script>hljs.initHighlightingOnLoad();</script> 
    </head>

    <body>

        <div class="navbar navbar-default navbar-fixed-top" role="navigation">
            <div class="container">

                <!-- Collapsed navigation -->
                <div class="navbar-header">
                    <!-- Expander button -->
                    <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                        <span class="sr-only">Toggle navigation</span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </button>
                    <a class="navbar-brand" href="../..">Zhenhua's Notes - Big Data</a>
                </div>

                <!-- Expanded navigation -->
                <div class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li >
                                <a href="../..">Home</a>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="dropdown-toggle" data-toggle="dropdown">HADOOP <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li >
    <a href="../../hadoop/">Contents</a>
</li>
                                    
<li >
    <a href="../../hadoop/ch1/">Chapter 1: Meet Hadoop</a>
</li>
                                    
<li >
    <a href="../../hadoop/ch2/">Chapter 2: MapReduce</a>
</li>
                                    
<li >
    <a href="../../hadoop/ch3/">Chapter 3: The Hadoop Distributed FileSystem</a>
</li>
                                    
<li >
    <a href="../../hadoop/ch4/">Chapter 4: YARN</a>
</li>
                                    
<li >
    <a href="../../hadoop/ch5/">Chapter 5: Hadoop I/O</a>
</li>
                                    
<li >
    <a href="../../hadoop/ch6/">Chapter 6: Developing a MapReduce Application</a>
</li>
                                    
<li >
    <a href="../../hadoop/ch7/">Chapter 7: How MapReduce Works</a>
</li>
                                    
<li >
    <a href="../../hadoop/ch8/">Chapter 8: MapReduce Types and Formats</a>
</li>
                                    
<li >
    <a href="../../hadoop/ch9/">Chapter 9: MapReduce Features</a>
</li>
                                    
<li >
    <a href="../../hadoop/ch10/">Chapter 10: Setting Up a Hadoop Cluster</a>
</li>
                                    
<li >
    <a href="../../hadoop/ch11/">Chapter 11: Adminstering Hadoop</a>
</li>
                                    
<li >
    <a href="../../hadoop/ch12/">Chapter 12: Avro</a>
</li>
                                    
<li >
    <a href="../../hadoop/ch13/">Chapter 13: Parquet</a>
</li>
                                    
<li >
    <a href="../../hadoop/ch14/">Chapter 14: Flume</a>
</li>
                                    
<li >
    <a href="../../hadoop/ch15/">Chapter 15: Sqoop</a>
</li>
                                    
<li >
    <a href="../../hadoop/ch16/">Chapter 16: Pig</a>
</li>
                                    
<li >
    <a href="../../hadoop/ch17/">Chapter 17: Hive</a>
</li>
                                    
<li >
    <a href="../../hadoop/ch18/">Chapter 18: Crunch</a>
</li>
                                    
<li >
    <a href="../../hadoop/ch19/">Chapter 19: Spark</a>
</li>
                                    
<li >
    <a href="../../hadoop/ch20/">Chapter 20: HBase</a>
</li>
                                    
<li >
    <a href="../../hadoop/ch21/">Chapter 21: ZooKeeper</a>
</li>
                                    
<li >
    <a href="../../hadoop/ch22/">Chapter 22: Composable Data at Center</a>
</li>
                                    
<li >
    <a href="../../hadoop/ch23/">Chapter 23: Biological Data Science: Saving Lives with Software</a>
</li>
                                    
<li >
    <a href="../../hadoop/ch24/">Chapter 24: Cascading</a>
</li>
                                </ul>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="dropdown-toggle" data-toggle="dropdown">Spark <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li >
    <a href="../../spark/">Contents</a>
</li>
                                    
<li >
    <a href="../../spark/ch1/">Chapter 1: Introduction to Data Analysis with Spark</a>
</li>
                                    
<li >
    <a href="../../spark/ch2/">Chapter 2: Downloading Spark and Getting Started</a>
</li>
                                    
<li >
    <a href="../../spark/ch3/">Chapter 3: Programming with RDDs</a>
</li>
                                    
<li >
    <a href="../../spark/ch4/">Chapter 4: Working with Key/Value Pairs</a>
</li>
                                    
<li >
    <a href="../../spark/ch5/">Chapter 5: Loading and Saving Your Data</a>
</li>
                                    
<li >
    <a href="../../spark/ch6/">Chapter 6: Advanced Spark Programming</a>
</li>
                                    
<li >
    <a href="../../spark/ch7/">Chapter 7: Running on a Cluster</a>
</li>
                                    
<li >
    <a href="../../spark/ch8/">Chapter 8: Tuning and Debugging Spark</a>
</li>
                                    
<li >
    <a href="../../spark/ch9/">Chapter 9: Spark SQL</a>
</li>
                                    
<li >
    <a href="../../spark/ch10/">Chapter 10: Spark Streaming</a>
</li>
                                    
<li >
    <a href="../../spark/ch11/">Chapter 11: Machine Learning with MLlib</a>
</li>
                                </ul>
                            </li>
                            <li class="dropdown active">
                                <a href="#" class="dropdown-toggle" data-toggle="dropdown">GDM <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li >
    <a href="../">Contents</a>
</li>
                                    
<li class="active">
    <a href="./">Chapter 1: 推荐系统入门</a>
</li>
                                    
<li >
    <a href="../ch2/">Chapter 2: 隐式评价和基于物品的过滤算法</a>
</li>
                                    
<li >
    <a href="../ch3/">Chapter 3: 分类</a>
</li>
                                    
<li >
    <a href="../ch4/">Chapter 4: 进一步探索分类</a>
</li>
                                    
<li >
    <a href="../ch5/">Chapter 5: 概率和朴素贝叶斯</a>
</li>
                                    
<li >
    <a href="../ch6/">Chapter 6: 朴素贝叶斯和文本数据</a>
</li>
                                    
<li >
    <a href="../ch7/">Chapter 7: 聚类</a>
</li>
                                </ul>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="dropdown-toggle" data-toggle="dropdown">MLIA <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li >
    <a href="../../mlia/">Contents</a>
</li>
                                    
<li >
    <a href="../../mlia/ch1/">Chapter 1: 机器学习基础</a>
</li>
                                    
<li >
    <a href="../../mlia/ch2/">Chapter 2: k-近邻算法</a>
</li>
                                    
<li >
    <a href="../../mlia/ch3/">Chapter 3: 决策树</a>
</li>
                                    
<li >
    <a href="../../mlia/ch4/">Chapter 4: 基于概率论的分类方法：朴素贝叶斯</a>
</li>
                                    
<li >
    <a href="../../mlia/ch5/">Chapter 5: Logistic回归</a>
</li>
                                    
<li >
    <a href="../../mlia/ch6/">Chapter 6: 支持向量机</a>
</li>
                                    
<li >
    <a href="../../mlia/ch7/">Chapter 7: 利用AdaBoost元算法提高分类性能</a>
</li>
                                    
<li >
    <a href="../../mlia/ch8/">Chapter 8: 预测数值型数据：回归</a>
</li>
                                    
<li >
    <a href="../../mlia/ch9/">Chapter 9: 树回归</a>
</li>
                                    
<li >
    <a href="../../mlia/ch10/">Chapter 10: 利用Ｋ-均值聚类算法对未标注数据分组</a>
</li>
                                    
<li >
    <a href="../../mlia/ch11/">Chapter 11: 使用Apriori算法进行关联分析</a>
</li>
                                    
<li >
    <a href="../../mlia/ch11/">Chapter 12: 使用FP-growth算法来高效发现频繁项集</a>
</li>
                                    
<li >
    <a href="../../mlia/ch13/">Chapter 13: 利用PCA来简化数据</a>
</li>
                                </ul>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="dropdown-toggle" data-toggle="dropdown">PROB <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li >
    <a href="../../prob/">Contents</a>
</li>
                                    
<li >
    <a href="../../prob/ch1/">Chapter 1: 样本空间和概率</a>
</li>
                                </ul>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="dropdown-toggle" data-toggle="dropdown">Projects <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li >
    <a href="../../projects/">Contents</a>
</li>
                                    
<li >
    <a href="../../projects/SparkStreaming实时流处理项目/">SparkStreaming实时流处理</a>
</li>
                                </ul>
                            </li>
                            <li >
                                <a href="../../books/">Books</a>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav navbar-right">
                        <li>
                            <a href="#" data-toggle="modal" data-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                            <li >
                                <a rel="next" href="../">
                                    <i class="fa fa-arrow-left"></i> Previous
                                </a>
                            </li>
                            <li >
                                <a rel="prev" href="../ch2/">
                                    Next <i class="fa fa-arrow-right"></i>
                                </a>
                            </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
                <div class="col-md-3"><div class="bs-sidebar hidden-print affix well" role="complementary">
    <ul class="nav bs-sidenav">
        <li class="main active"><a href="#-1">面向程序员的数据挖掘指南 - 1 推荐系统入门</a></li>
        <li class="main "><a href="#_1">曼哈顿距离</a></li>
            <li><a href="#_2">欧几里得距离</a></li>
            <li><a href="#_3">闵可夫斯基距离</a></li>
            <li><a href="#_4">切比雪夫距离</a></li>
            <li><a href="#_5">皮尔逊相关系数</a></li>
            <li><a href="#_6">余弦相似度</a></li>
            <li><a href="#_7">应该使用哪种相似度？</a></li>
        <li class="main "><a href="#knn">kNN</a></li>
        <li class="main "><a href="#python">Python推荐模块</a></li>
    </ul>
</div></div>
                <div class="col-md-9" role="main">

<h3 id="-1"><strong>面向程序员的数据挖掘指南 - 1 推荐系统入门</strong><a class="headerlink" href="#-1" title="Permanent link">&para;</a></h3>
<p>本章将介绍协同过滤，基本的距离算法，最后使用Python实现一个简单的推荐算法。</p>
<p>协同过滤，顾名思义，是利用他人的喜好来进行推荐，也就是说，是大家一起产生的推荐。它的工作原理是，在网站上查找一个和你类似的用户，然后将它喜欢的书籍推荐给你。</p>
<p>如何找到相似的用户？</p>
<h3 id="_1">曼哈顿距离<a class="headerlink" href="#_1" title="Permanent link">&para;</a></h3>
<p>顾名思义，在曼哈顿街区要从一个十字路口开车到另一个十字路口，实际驾驶距离就是“曼哈顿距离”。</p>
<p><img alt="" src="../figures/ManhattanDistanceDemo1.jpg" /></p>
<p>最简单的距离计算方式是曼哈顿距离。在二维模型中，每个人都可以用<span><span class="MathJax_Preview">(x, y)</span><script type="math/tex">(x, y)</script></span>的点来表示，这里用下标来表示不同的人，<span><span class="MathJax_Preview">(x_1, y_1)</span><script type="math/tex">(x_1, y_1)</script></span>表示艾米，<span><span class="MathJax_Preview">(x_2, y_2)</span><script type="math/tex">(x_2, y_2)</script></span>表示神秘的X先生，那么他们之间的曼哈顿距离就是：</p>
<div>
<div class="MathJax_Preview">|x_1-x_2|+|y_1-y_2|</div>
<script type="math/tex; mode=display">|x_1-x_2|+|y_1-y_2|</script>
</div>
<p><img alt="ManhattanDistanceDemo" src="../figures/ManhattanDistanceDemo.png" /></p>
<p>曼哈顿距离的优点之一是计算速度快，对于Facebook这样需要计算百万用户之间的相似度时就非常有利。</p>
<p> <div class=codehilite><pre><span class=k>def</span> <span class=nf>manhattan</span><span class=p>(</span><span class=n>rating1</span><span class=p>,</span> <span class=n>rating2</span><span class=p>):</span>
    <span class=sd>&quot;&quot;&quot;Computes the Manhattan distance. Both rating1 and rating2 are dictionaries</span>
<span class=sd>       of the form {&#39;The Strokes&#39;: 3.0, &#39;Slightly Stoopid&#39;: 2.5}&quot;&quot;&quot;</span>
    <span class=n>distance</span> <span class=o>=</span> <span class=mi>0</span>
    <span class=n>commonRatings</span> <span class=o>=</span> <span class=bp>False</span> 
    <span class=k>for</span> <span class=n>key</span> <span class=ow>in</span> <span class=n>rating1</span><span class=p>:</span>
        <span class=k>if</span> <span class=n>key</span> <span class=ow>in</span> <span class=n>rating2</span><span class=p>:</span>
            <span class=n>distance</span> <span class=o>+=</span> <span class=nb>abs</span><span class=p>(</span><span class=n>rating1</span><span class=p>[</span><span class=n>key</span><span class=p>]</span> <span class=o>-</span> <span class=n>rating2</span><span class=p>[</span><span class=n>key</span><span class=p>])</span>
            <span class=n>commonRatings</span> <span class=o>=</span> <span class=bp>True</span>
    <span class=k>if</span> <span class=n>commonRatings</span><span class=p>:</span>
        <span class=k>return</span> <span class=n>distance</span>
    <span class=k>else</span><span class=p>:</span>
        <span class=k>return</span> <span class=o>-</span><span class=mi>1</span> <span class=c1>#Indicates no ratings in common</span>
</pre></div></p>
<h4 id="_2">欧几里得距离<a class="headerlink" href="#_2" title="Permanent link">&para;</a></h4>
<p>欧几里得距离就是两点之间的直线距离。 下面的斜线就是欧几里得距离，公式是：</p>
<div>
<div class="MathJax_Preview">\sqrt{(x_1-x_2)^2+(y_1-y_2)^2}</div>
<script type="math/tex; mode=display">\sqrt{(x_1-x_2)^2+(y_1-y_2)^2}</script>
</div>
<p><img alt="Euclidean Distance Demo" src="../figures/EuclidDistanceDemo.png" /></p>
<p>曼哈顿距离和欧几里得距离在数据完整的情况下效果最好。</p>
<p> <div class=codehilite><pre><span class=k>def</span> <span class=nf>euclidean</span><span class=p>(</span><span class=n>rating1</span><span class=p>,</span> <span class=n>rating2</span><span class=p>):</span>
    <span class=sd>&quot;&quot;&quot;</span>
<span class=sd>    Computes the Euclidean Distance</span>
<span class=sd>    :param rating1: rating</span>
<span class=sd>    :param rating2: rating</span>
<span class=sd>    :return: distance if common ratings exists, or -1</span>
<span class=sd>    &quot;&quot;&quot;</span>
    <span class=n>distance</span> <span class=o>=</span> <span class=mi>0</span>
    <span class=n>commonRatings</span> <span class=o>=</span> <span class=bp>False</span>
    <span class=k>for</span> <span class=n>key</span> <span class=ow>in</span> <span class=n>rating1</span><span class=p>:</span>
        <span class=k>if</span> <span class=n>key</span> <span class=ow>in</span> <span class=n>rating2</span><span class=p>:</span>
            <span class=n>distance</span> <span class=o>+=</span> <span class=nb>pow</span><span class=p>(</span><span class=n>rating1</span><span class=p>[</span><span class=n>key</span><span class=p>]</span> <span class=o>-</span> <span class=n>rating2</span><span class=p>[</span><span class=n>key</span><span class=p>],</span> <span class=mi>2</span><span class=p>)</span>
            <span class=n>commonRatings</span> <span class=o>=</span> <span class=bp>True</span>

    <span class=k>if</span> <span class=n>commonRatings</span><span class=p>:</span>
        <span class=k>return</span> <span class=n>distance</span>
    <span class=k>else</span><span class=p>:</span>
        <span class=k>return</span> <span class=o>-</span><span class=mi>1</span>  <span class=c1># Indicates no ratings in common</span>
</pre></div></p>
<h4 id="_3">闵可夫斯基距离<a class="headerlink" href="#_3" title="Permanent link">&para;</a></h4>
<p>我们可以将曼哈顿距离和欧几里得距离归纳成一个公式，这个公式称为闵可夫斯基距离(Minkowski Distance)：</p>
<div>
<div class="MathJax_Preview">d(x,y) = (\sum_{k=1}^{n}|x_k-y_k|^r)^{\frac{1}{r}}</div>
<script type="math/tex; mode=display">d(x,y) = (\sum_{k=1}^{n}|x_k-y_k|^r)^{\frac{1}{r}}</script>
</div>
<p>其中：</p>
<ul>
<li><span><span class="MathJax_Preview">r = 1</span><script type="math/tex">r = 1</script></span>, 该公式即曼哈顿距离</li>
<li><span><span class="MathJax_Preview">r = 2</span><script type="math/tex">r = 2</script></span>, 该公式即欧几里得距离</li>
<li><span><span class="MathJax_Preview">r = \infty</span><script type="math/tex">r = \infty</script></span>, 切比雪夫距离</li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><span><span class="MathJax_Preview">r</span><script type="math/tex">r</script></span>值越大，单个维度的差值大小会对整体距离有更大的影响。</p>
</div>
<h4 id="_4">切比雪夫距离<a class="headerlink" href="#_4" title="Permanent link">&para;</a></h4>
<p>切比雪夫距离(Chebyshev Distance)是定义为其各坐标数值差的最大值。</p>
<div>
<div class="MathJax_Preview">D_{\rm Chebyshev}(x,y) = \max_i(|x_i - y_i|)=\lim_{k \to \infty} \bigg( \sum_{i=1}^n \left| x_i - y_i \right|^k \bigg)^{1/k}</div>
<script type="math/tex; mode=display">D_{\rm Chebyshev}(x,y) = \max_i(|x_i - y_i|)=\lim_{k \to \infty} \bigg( \sum_{i=1}^n \left| x_i - y_i \right|^k \bigg)^{1/k}</script>
</div>
<p> <div class=codehilite><pre><span class=k>def</span> <span class=nf>chebyshev</span><span class=p>(</span><span class=n>rating1</span><span class=p>,</span> <span class=n>rating2</span><span class=p>):</span>
    <span class=sd>&quot;&quot;&quot;</span>
<span class=sd>    Computes the Chebyshev Distance</span>
<span class=sd>    :param rating1: rating</span>
<span class=sd>    :param rating2: rating</span>
<span class=sd>    :return: distance if common ratings exists, or -1</span>
<span class=sd>    &quot;&quot;&quot;</span>
    <span class=n>distance</span> <span class=o>=</span> <span class=mi>0</span>
    <span class=n>commonRatings</span> <span class=o>=</span> <span class=bp>False</span>
    <span class=k>for</span> <span class=n>key</span> <span class=ow>in</span> <span class=n>rating1</span><span class=p>:</span>
        <span class=k>if</span> <span class=n>key</span> <span class=ow>in</span> <span class=n>rating2</span><span class=p>:</span>
            <span class=n>distance</span> <span class=o>=</span> <span class=nb>max</span><span class=p>(</span><span class=n>distance</span><span class=p>,</span> <span class=nb>abs</span><span class=p>(</span><span class=n>rating1</span><span class=p>[</span><span class=n>key</span><span class=p>]</span> <span class=o>-</span> <span class=n>rating2</span><span class=p>[</span><span class=n>key</span><span class=p>]))</span>
            <span class=n>commonRatings</span> <span class=o>=</span> <span class=bp>True</span>

    <span class=k>if</span> <span class=n>commonRatings</span><span class=p>:</span>
        <span class=k>return</span> <span class=n>distance</span>
    <span class=k>else</span><span class=p>:</span>
        <span class=k>return</span> <span class=o>-</span><span class=mi>1</span>  <span class=c1># Indicates no ratings in common</span>
</pre></div></p>
<h4 id="_5">皮尔逊相关系数<a class="headerlink" href="#_5" title="Permanent link">&para;</a></h4>
<p>让我们仔细看看用户对乐队的评分，可以发现每个用户的打分标准非常不同：</p>
<ul>
<li>Bill没有打出极端的分数，都在2至4分之间； </li>
<li>Jordyn似乎喜欢所有的乐队，打分都在4至5之间； </li>
<li>Hailey是一个有趣的人，他的分数不是1就是4。</li>
</ul>
<p>那么，如何比较这些用户呢？比如Hailey的4分相当于Jordan的4分还是5分呢？我觉得更接近5分。这样一来就会影响到推荐系统的准确性了。Clara最低给了4分——她所有的打分都在4至5分之间，这种现象在数据挖掘领域称为<strong>分数膨胀</strong>。</p>
<p><img alt="pearsonCoefficient" src="../figures/pearsonCoefficient.png" /></p>
<p>解决方法之一是使用皮尔逊相关系数, 用于度量两个变量X和Y之间的相关(线性相关)，其值介于-1与1之间, 1表示完全吻合，-1表示完全相悖。下面是常见的几组<span><span class="MathJax_Preview">(x, y)</span><script type="math/tex">(x, y)</script></span>点集的皮尔逊相关系数。</p>
<p><img alt="commonperasonCoefficient" src="../figures/commonperasonCoefficient.png" /></p>
<p>两个变量之间的皮尔逊相关系数定义为两个变量之间的协方差(<span><span class="MathJax_Preview">\text{cov}(X,Y)</span><script type="math/tex">\text{cov}(X,Y)</script></span>)和标准差(<span><span class="MathJax_Preview">\sigma_X</span><script type="math/tex">\sigma_X</script></span>)的商：</p>
<div>
<div class="MathJax_Preview">\rho_{X,Y}={\mathrm{cov}(X,Y) \over \sigma_X \sigma_Y} ={E[(X-\mu_X)(Y-\mu_Y)] \over \sigma_X\sigma_Y}</div>
<script type="math/tex; mode=display">\rho_{X,Y}={\mathrm{cov}(X,Y) \over \sigma_X \sigma_Y} ={E[(X-\mu_X)(Y-\mu_Y)] \over \sigma_X\sigma_Y}</script>
</div>
<p>对于样本皮尔逊相关系数:</p>
<div>
<div class="MathJax_Preview">r_{xy}=\frac{\sum x_iy_i-n \bar{x} \bar{y}}{(n-1) s_x s_y}=\frac{n\sum x_iy_i-\sum x_i\sum y_i}{\sqrt{n\sum x_i^2-(\sum x_i)^2}~\sqrt{n\sum y_i^2-(\sum y_i)^2}}.</div>
<script type="math/tex; mode=display">r_{xy}=\frac{\sum x_iy_i-n \bar{x} \bar{y}}{(n-1) s_x s_y}=\frac{n\sum x_iy_i-\sum x_i\sum y_i}{\sqrt{n\sum x_i^2-(\sum x_i)^2}~\sqrt{n\sum y_i^2-(\sum y_i)^2}}.</script>
</div>
<p>以上方程给出了计算样本皮尔逊相关系数简单的单流程算法，但是其依赖于涉及到的数据，有时它可能是数值不稳定的。但它最大的优点是，用代码实现的时候可以只遍历一次数据。</p>
<p> <div class=codehilite><pre>    <span class=k>def</span> <span class=nf>pearson</span><span class=p>(</span><span class=n>rating1</span><span class=p>,</span> <span class=n>rating2</span><span class=p>):</span>
        <span class=sd>&quot;&quot;&quot;</span>
<span class=sd>        Compute pearson coefficient</span>
<span class=sd>        :param rating1: a dictionary</span>
<span class=sd>        :param rating2: a dictionary</span>
<span class=sd>        :return: pearson coefficient</span>
<span class=sd>        &quot;&quot;&quot;</span>
        <span class=n>sum_xy</span> <span class=o>=</span> <span class=mi>0</span>
        <span class=n>sum_x</span> <span class=o>=</span> <span class=mi>0</span>
        <span class=n>sum_y</span> <span class=o>=</span> <span class=mi>0</span>
        <span class=n>sum_x2</span> <span class=o>=</span> <span class=mi>0</span>
        <span class=n>sum_y2</span> <span class=o>=</span> <span class=mi>0</span>
        <span class=n>n</span> <span class=o>=</span> <span class=mi>0</span>
        <span class=n>commonRatings</span> <span class=o>=</span> <span class=bp>False</span>
        <span class=k>for</span> <span class=n>key</span> <span class=ow>in</span> <span class=n>rating1</span><span class=p>:</span>
            <span class=k>if</span> <span class=n>key</span> <span class=ow>in</span> <span class=n>rating2</span><span class=p>:</span>
                <span class=n>n</span> <span class=o>+=</span> <span class=mi>1</span>
                <span class=n>x</span> <span class=o>=</span> <span class=n>rating1</span><span class=p>[</span><span class=n>key</span><span class=p>]</span>
                <span class=n>y</span> <span class=o>=</span> <span class=n>rating2</span><span class=p>[</span><span class=n>key</span><span class=p>]</span>
                <span class=n>sum_xy</span> <span class=o>+=</span> <span class=n>x</span> <span class=o>*</span> <span class=n>y</span>
                <span class=n>sum_x</span> <span class=o>+=</span> <span class=n>x</span>
                <span class=n>sum_y</span> <span class=o>+=</span> <span class=n>y</span>
                <span class=n>sum_x2</span> <span class=o>+=</span> <span class=nb>pow</span><span class=p>(</span><span class=n>x</span><span class=p>,</span> <span class=mi>2</span><span class=p>)</span>
                <span class=n>sum_y2</span> <span class=o>+=</span> <span class=nb>pow</span><span class=p>(</span><span class=n>y</span><span class=p>,</span> <span class=mi>2</span><span class=p>)</span>
                <span class=n>commonRatings</span> <span class=o>=</span> <span class=bp>True</span>

        <span class=k>if</span> <span class=ow>not</span> <span class=n>commonRatings</span><span class=p>:</span>
            <span class=k>return</span> <span class=o>-</span><span class=mi>1</span>
        <span class=c1># now compute denominator</span>
        <span class=n>denominator</span> <span class=o>=</span> <span class=n>math</span><span class=o>.</span><span class=n>sqrt</span><span class=p>(</span><span class=n>sum_x2</span> <span class=o>-</span> <span class=nb>pow</span><span class=p>(</span><span class=n>sum_x</span><span class=p>,</span> <span class=mi>2</span><span class=p>)</span> <span class=o>/</span> <span class=n>n</span><span class=p>)</span> <span class=o>*</span> <span class=n>math</span><span class=o>.</span><span class=n>sqrt</span><span class=p>(</span><span class=n>sum_y2</span> <span class=o>-</span> <span class=nb>pow</span><span class=p>(</span><span class=n>sum_y</span><span class=p>,</span> <span class=mi>2</span><span class=p>)</span> <span class=o>/</span> <span class=n>n</span><span class=p>)</span>
        <span class=k>if</span> <span class=n>denominator</span> <span class=o>==</span> <span class=mi>0</span><span class=p>:</span>
            <span class=k>return</span> <span class=mi>0</span>
        <span class=k>else</span><span class=p>:</span>
            <span class=k>return</span> <span class=p>(</span><span class=n>sum_xy</span> <span class=o>-</span> <span class=p>(</span><span class=n>sum_x</span> <span class=o>*</span> <span class=n>sum_y</span><span class=p>)</span> <span class=o>/</span> <span class=n>n</span><span class=p>)</span> <span class=o>/</span> <span class=n>denominator</span>
</pre></div></p>
<h4 id="_6">余弦相似度<a class="headerlink" href="#_6" title="Permanent link">&para;</a></h4>
<p>当我们用1500万首歌曲来比较两个用户时，很有可能他们之间没有任何交集，这样一来就无从计算他们之间的距离了。类似的情况是在计算两篇文章的相似度时。余弦相似度的计算中会略过这些非零值。它的计算公式是：</p>
<div>
<div class="MathJax_Preview">\cos(x,y) = \frac{x\cdot y}{||x||\times||y||}</div>
<script type="math/tex; mode=display">\cos(x,y) = \frac{x\cdot y}{||x||\times||y||}</script>
</div>
<p>其中，<span><span class="MathJax_Preview">\cdot</span><script type="math/tex">\cdot</script></span> 号表示数量积。<span><span class="MathJax_Preview">||x||</span><script type="math/tex">||x||</script></span>表示向量<span><span class="MathJax_Preview">x</span><script type="math/tex">x</script></span>的模。</p>
<p>余弦相似度在文本挖掘中应用得较多，在协同过滤中也会使用到。</p>
<h4 id="_7">应该使用哪种相似度？<a class="headerlink" href="#_7" title="Permanent link">&para;</a></h4>
<ul>
<li>如果数据存在“分数膨胀”问题，就使用皮尔逊相关系数。 </li>
<li>如果数据比较“密集”，变量之间基本都存在公有值，且这些距离数据是非常重要的，那就使用欧几里得或曼哈顿距离。</li>
<li>如果数据是稀疏的，则使用余弦相似度。</li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>在数据标准化(<span><span class="MathJax_Preview">\mu=0,\sigma=1</span><script type="math/tex">\mu=0,\sigma=1</script></span>）后，Pearson相关性系数、余弦相似度、欧式距离的平方可认为是等价的[<a href="https://www.zhihu.com/question/19734616">1</a>]。</p>
</div>
<h3 id="knn">kNN<a class="headerlink" href="#knn" title="Permanent link">&para;</a></h3>
<p>上面的做法中，我们只依靠最相似的一个用户来做推荐，如果这个用户有些特殊的偏好，就会直接反映在推荐内容里。解决方法之一是找寻多个相似的用户，这里就要用到K最邻近算法了。</p>
<p>在协同过滤中可以使用K最邻近算法来找出K个最相似的用户，以此作为推荐的基础。不同的 应用有不同的K值，需要做一些实验来得出。以下给到读者一个基本的思路。 假设我要为Ann做推荐，并令K=3。使用皮尔逊相关系数得到的结果是：</p>
<table>
<thead>
<tr>
<th>Person</th>
<th>Pearson</th>
</tr>
</thead>
<tbody>
<tr>
<td>Sally</td>
<td>0.8</td>
</tr>
<tr>
<td>Eric</td>
<td>0.7</td>
</tr>
<tr>
<td>Amanda</td>
<td>0.5</td>
</tr>
</tbody>
</table>
<p>这三个人都会对推荐结果有所贡献，问题在于我们如何确定他们的比重呢？ 我们直接用相关系数的比重来描述，Sally的比重是0.8/2=40%，Eric是0.7/2=35%，Amanda 则是25%：</p>
<p>假设他们三人对Grey Wardens的评分以及加权后的结果如下：</p>
<table>
<thead>
<tr>
<th>Person</th>
<th>Grey Wardens Rating</th>
<th>Influence</th>
</tr>
</thead>
<tbody>
<tr>
<td>Sally</td>
<td>4.5</td>
<td>25%</td>
</tr>
<tr>
<td>Eric</td>
<td>5</td>
<td>35%</td>
</tr>
<tr>
<td>Amanda</td>
<td>3.5</td>
<td>40%</td>
</tr>
</tbody>
</table>
<p>最后计算得到的分数为为加权和 <span><span class="MathJax_Preview">4.5\times 25\% + 5\times 35\% + 3.5 \times 40\%</span><script type="math/tex">4.5\times 25\% + 5\times 35\% + 3.5 \times 40\%</script></span>。</p>
<h3 id="python">Python推荐模块<a class="headerlink" href="#python" title="Permanent link">&para;</a></h3>
<p>Cai-Nicolas Zeigler从图书漂流站收集了超过100万条评价数据——278,858位用户为271,379本书打了分。数据可以从这个<a href="http://www2.informatik.uni-freiburg.de/~cziegler/BX/">地址</a>获得。</p>
<p>CSV文件包含了三张表：</p>
<ul>
<li>用户表，包括用户ID、位置、年龄等信息。其中用户的姓名已经隐去； </li>
<li>书籍表，包括ISBN号、标题、作者、出版日期、出版社等；</li>
<li>评分表，包括用户ID、书籍ISBN号、以及评分（0-10分）。</li>
</ul>
<div class=md-fenced-code-tabs id=tab-tab-group-4><input name=tab-group-4 type=radio id=tab-group-4-0_python checked=checked class=code-tab data-lang=python aria-controls=tab-group-4-0_python-panel role=tab><label for=tab-group-4-0_python class=code-tab-label data-lang=python id=tab-group-4-0_python-label>Recommender</label><div class=code-tabpanel role=tabpanel data-lang=python id=tab-group-4-0_python-panel aria-labelledby=tab-group-4-0_python-label><div class=codehilite><pre><span class=k>class</span> <span class=nc>Recommender</span><span class=p>:</span>

    <span class=k>def</span> <span class=nf>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>books</span><span class=p>,</span> <span class=n>users</span><span class=p>,</span> <span class=n>user_ratings</span><span class=p>,</span> <span class=n>book_ratings</span><span class=p>):</span>
        <span class=sd>&quot;&quot;&quot;</span>
<span class=sd>        initialize basic data</span>
<span class=sd>        :param books: a dictionary of books, whose key is book id</span>
<span class=sd>        :param users: a dictionary of users, whose key is user id</span>
<span class=sd>        :param book_ratings: a dictionary of book ratings, whose key is book id</span>
<span class=sd>        :param user_ratings: a dictionary of user ratings, whose key is user id</span>
<span class=sd>        &quot;&quot;&quot;</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>books</span> <span class=o>=</span> <span class=n>books</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>users</span> <span class=o>=</span> <span class=n>users</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>book_ratings</span> <span class=o>=</span> <span class=n>book_ratings</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>user_ratings</span> <span class=o>=</span> <span class=n>user_ratings</span>

    <span class=k>def</span> <span class=nf>recommend</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>user_to_recommend_int</span><span class=p>,</span> <span class=n>k</span><span class=o>=</span><span class=mi>1</span><span class=p>):</span>
        <span class=sd>&quot;&quot;&quot;</span>
<span class=sd>        Recommend user books</span>
<span class=sd>        :param user_to_recommend_int: int, user id</span>
<span class=sd>        :param k : int, for nearest k neighbors</span>
<span class=sd>        :return: a list of books</span>
<span class=sd>        &quot;&quot;&quot;</span>
        <span class=n>user_to_recommend</span> <span class=o>=</span> <span class=nb>str</span><span class=p>(</span><span class=n>user_to_recommend_int</span><span class=p>)</span>
        <span class=k>if</span> <span class=n>user_to_recommend</span> <span class=ow>not</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>users</span><span class=p>:</span>
            <span class=k>raise</span> <span class=ne>Exception</span><span class=p>(</span><span class=s2>&quot;user does not exist!!&quot;</span><span class=p>)</span>

        <span class=c1># find the user having min distances from user_to_recommend</span>
        <span class=n>distances</span> <span class=o>=</span> <span class=p>[]</span>
        <span class=n>find_user</span> <span class=o>=</span> <span class=bp>False</span>
        <span class=k>for</span> <span class=n>user</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>users</span><span class=p>:</span>
            <span class=k>if</span> <span class=n>user_to_recommend</span> <span class=o>==</span> <span class=n>user</span><span class=p>:</span>
                <span class=k>continue</span>
            <span class=c1># extract user ratings based on user ids, </span>
            <span class=c1># and compute the distance between them</span>
            <span class=n>distance</span> <span class=o>=</span> <span class=n>Distance</span><span class=o>.</span><span class=n>pearson</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>user_ratings</span><span class=p>[</span><span class=n>user_to_recommend</span><span class=p>],</span> 
                 <span class=bp>self</span><span class=o>.</span><span class=n>user_ratings</span><span class=p>[</span><span class=n>user</span><span class=p>])</span>
            <span class=k>if</span> <span class=n>distance</span> <span class=o>!=</span> <span class=o>-</span><span class=mi>1</span><span class=p>:</span>
                <span class=n>distances</span><span class=o>.</span><span class=n>append</span><span class=p>([</span><span class=n>user</span><span class=p>,</span> <span class=n>distance</span><span class=p>])</span>
                <span class=n>find_user</span> <span class=o>=</span> <span class=bp>True</span>

        <span class=k>if</span> <span class=ow>not</span> <span class=n>find_user</span><span class=p>:</span>
            <span class=k>return</span> <span class=p>[]</span>

        <span class=c1># sort user based on their distances</span>
        <span class=c1># pearson 系数越大，距离越近，所以用reverse</span>
        <span class=n>distances</span><span class=o>.</span><span class=n>sort</span><span class=p>(</span><span class=n>key</span><span class=o>=</span><span class=k>lambda</span> <span class=n>x</span><span class=p>:</span> <span class=n>x</span><span class=p>[</span><span class=mi>1</span><span class=p>],</span> <span class=n>reverse</span><span class=o>=</span><span class=bp>True</span><span class=p>)</span>

        <span class=c1># compute weight based on distances</span>
        <span class=n>distances</span> <span class=o>=</span> <span class=n>distances</span><span class=p>[</span><span class=mi>0</span><span class=p>:</span><span class=n>k</span><span class=p>]</span>
        <span class=n>sum_distance</span> <span class=o>=</span> <span class=nb>sum</span><span class=p>([</span><span class=n>distance</span> <span class=k>for</span> <span class=n>user</span><span class=p>,</span> <span class=n>distance</span> <span class=ow>in</span> <span class=n>distances</span><span class=p>])</span>
        <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>distances</span><span class=p>)):</span>
            <span class=n>distances</span><span class=p>[</span><span class=n>i</span><span class=p>][</span><span class=mi>1</span><span class=p>]</span> <span class=o>/=</span> <span class=n>sum_distance</span>

        <span class=c1># recommend books</span>
        <span class=n>books_to_recommend</span> <span class=o>=</span> <span class=p>{}</span>
        <span class=k>for</span> <span class=n>user_id</span><span class=p>,</span> <span class=n>weight</span> <span class=ow>in</span> <span class=n>distances</span><span class=p>:</span>
            <span class=k>for</span> <span class=n>book_id</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>user_ratings</span><span class=p>[</span><span class=n>user_id</span><span class=p>]:</span>
                    <span class=k>if</span> <span class=n>book_id</span> <span class=ow>not</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>user_ratings</span><span class=p>[</span><span class=n>user_to_recommend</span><span class=p>]:</span>  <span class=c1># the user haven&#39;t seen</span>
                        <span class=k>if</span> <span class=n>book_id</span> <span class=ow>not</span> <span class=ow>in</span> <span class=n>books_to_recommend</span><span class=p>:</span>  <span class=c1># haven&#39;t recommend</span>
                            <span class=n>books_to_recommend</span><span class=p>[</span><span class=n>book_id</span><span class=p>]</span> <span class=o>=</span> 
                                 <span class=bp>self</span><span class=o>.</span><span class=n>user_ratings</span><span class=p>[</span><span class=n>user_id</span><span class=p>][</span><span class=n>book_id</span><span class=p>]</span><span class=o>*</span><span class=n>weight</span>
                        <span class=k>else</span><span class=p>:</span>
                            <span class=n>books_to_recommend</span><span class=p>[</span><span class=n>book_id</span><span class=p>]</span> <span class=o>=</span> <span class=n>books_to_recommend</span><span class=p>[</span><span class=n>book_id</span><span class=p>]</span> \
                                <span class=o>+</span> <span class=bp>self</span><span class=o>.</span><span class=n>user_ratings</span><span class=p>[</span><span class=n>user_id</span><span class=p>][</span><span class=n>book_id</span><span class=p>]</span><span class=o>*</span><span class=n>weight</span>

        <span class=c1># transform to a  list of tuple</span>
        <span class=n>books_to_recommend</span> <span class=o>=</span> <span class=p>[(</span><span class=n>book_id</span><span class=p>,</span> <span class=n>project_rating</span><span class=p>)</span> 
              <span class=k>for</span> <span class=n>book_id</span><span class=p>,</span> <span class=n>project_rating</span> <span class=ow>in</span> <span class=n>books_to_recommend</span><span class=o>.</span><span class=n>items</span><span class=p>()]</span>

        <span class=c1># sort based on project_rating</span>
        <span class=n>books_to_recommend</span><span class=o>.</span><span class=n>sort</span><span class=p>(</span><span class=n>key</span><span class=o>=</span><span class=k>lambda</span> <span class=n>x</span><span class=p>:</span> <span class=n>x</span><span class=p>[</span><span class=mi>1</span><span class=p>],</span> <span class=n>reverse</span><span class=o>=</span><span class=bp>True</span><span class=p>)</span>

        <span class=c1># extract book title</span>
        <span class=n>books_to_recommend</span> <span class=o>=</span> <span class=p>[</span><span class=bp>self</span><span class=o>.</span><span class=n>books</span><span class=p>[</span><span class=n>book_id</span><span class=p>][</span><span class=s2>&quot;title&quot;</span><span class=p>]</span>
               <span class=k>for</span> <span class=n>book_id</span><span class=p>,</span> <span class=n>project_rating</span> <span class=ow>in</span> <span class=n>books_to_recommend</span><span class=p>]</span>
        <span class=k>return</span> <span class=n>books_to_recommend</span>


<span class=k>if</span> <span class=n>__name__</span> <span class=o>==</span> <span class=s2>&quot;__main__&quot;</span><span class=p>:</span>
    <span class=n>ratings</span> <span class=o>=</span> <span class=n>BooksImport</span><span class=p>()</span>
    <span class=n>books</span><span class=p>,</span> <span class=n>users</span><span class=p>,</span> <span class=n>user_ratings</span><span class=p>,</span> <span class=n>book_ratings</span> <span class=o>=</span> <span class=n>ratings</span><span class=o>.</span><span class=n>recommender_import</span><span class=p>()</span>
    <span class=n>test</span> <span class=o>=</span> <span class=n>Recommender</span><span class=p>(</span><span class=n>books</span><span class=p>,</span> <span class=n>users</span><span class=p>,</span> <span class=n>user_ratings</span><span class=p>,</span> <span class=n>book_ratings</span><span class=p>)</span>
    <span class=k>print</span><span class=p>(</span><span class=n>test</span><span class=o>.</span><span class=n>recommend</span><span class=p>(</span><span class=mi>171118</span><span class=p>))</span>
</pre></div></div><input name=tab-group-4 type=radio id=tab-group-4-1_python class=code-tab data-lang=python aria-controls=tab-group-4-1_python-panel role=tab><label for=tab-group-4-1_python class=code-tab-label data-lang=python id=tab-group-4-1_python-label>Distance</label><div class=code-tabpanel role=tabpanel data-lang=python id=tab-group-4-1_python-panel aria-labelledby=tab-group-4-1_python-label><div class=codehilite><pre><span class=kn>import</span> <span class=nn>math</span>


<span class=k>class</span> <span class=nc>Distance</span><span class=p>:</span>
    <span class=sd>&quot;&quot;&quot;</span>
<span class=sd>    Compute distance of two users, having different ratings.</span>

<span class=sd>    Both rating1 and rating2 are</span>
<span class=sd>    dictionaries of the form {&#39;The Strokes&#39;: 3.0, &#39;Slightly Stoopid&#39;: 2.5}</span>
<span class=sd>    &quot;&quot;&quot;</span>

    <span class=k>def</span> <span class=nf>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
        <span class=k>pass</span>

    <span class=nd>@staticmethod</span>
    <span class=k>def</span> <span class=nf>manhattan</span><span class=p>(</span><span class=n>rating1</span><span class=p>,</span> <span class=n>rating2</span><span class=p>):</span>
        <span class=sd>&quot;&quot;&quot;</span>
<span class=sd>        Computes the Manhattan distance.</span>
<span class=sd>        &quot;&quot;&quot;</span>
        <span class=n>distance</span> <span class=o>=</span> <span class=mi>0</span>
        <span class=n>common_ratings</span> <span class=o>=</span> <span class=bp>False</span>
        <span class=k>for</span> <span class=n>key</span> <span class=ow>in</span> <span class=n>rating1</span><span class=p>:</span>
            <span class=k>if</span> <span class=n>key</span> <span class=ow>in</span> <span class=n>rating2</span><span class=p>:</span>
                <span class=n>distance</span> <span class=o>+=</span> <span class=nb>abs</span><span class=p>(</span><span class=n>rating1</span><span class=p>[</span><span class=n>key</span><span class=p>]</span> <span class=o>-</span> <span class=n>rating2</span><span class=p>[</span><span class=n>key</span><span class=p>])</span>
                <span class=n>common_ratings</span> <span class=o>=</span> <span class=bp>True</span>
        <span class=k>if</span> <span class=n>common_ratings</span><span class=p>:</span>
            <span class=k>return</span> <span class=n>distance</span>
        <span class=k>else</span><span class=p>:</span>
            <span class=k>return</span> <span class=o>-</span><span class=mi>1</span>  <span class=c1># Indicates no ratings in common</span>

    <span class=nd>@staticmethod</span>
    <span class=k>def</span> <span class=nf>euclidean</span><span class=p>(</span><span class=n>rating1</span><span class=p>,</span> <span class=n>rating2</span><span class=p>):</span>
        <span class=sd>&quot;&quot;&quot;</span>
<span class=sd>        Computes the Euclidean Distance</span>
<span class=sd>        :param rating1: rating</span>
<span class=sd>        :param rating2: rating</span>
<span class=sd>        :return: distance if common ratings exists, or -1</span>
<span class=sd>        &quot;&quot;&quot;</span>
        <span class=n>distance</span> <span class=o>=</span> <span class=mi>0</span>
        <span class=n>commonRatings</span> <span class=o>=</span> <span class=bp>False</span>
        <span class=k>for</span> <span class=n>key</span> <span class=ow>in</span> <span class=n>rating1</span><span class=p>:</span>
            <span class=k>if</span> <span class=n>key</span> <span class=ow>in</span> <span class=n>rating2</span><span class=p>:</span>
                <span class=n>distance</span> <span class=o>+=</span> <span class=nb>pow</span><span class=p>(</span><span class=n>rating1</span><span class=p>[</span><span class=n>key</span><span class=p>]</span> <span class=o>-</span> <span class=n>rating2</span><span class=p>[</span><span class=n>key</span><span class=p>],</span> <span class=mi>2</span><span class=p>)</span>
                <span class=n>commonRatings</span> <span class=o>=</span> <span class=bp>True</span>

        <span class=k>if</span> <span class=n>commonRatings</span><span class=p>:</span>
            <span class=k>return</span> <span class=n>distance</span>
        <span class=k>else</span><span class=p>:</span>
            <span class=k>return</span> <span class=o>-</span><span class=mi>1</span>  <span class=c1># Indicates no ratings in common</span>

    <span class=nd>@staticmethod</span>
    <span class=k>def</span> <span class=nf>chebyshev</span><span class=p>(</span><span class=n>rating1</span><span class=p>,</span> <span class=n>rating2</span><span class=p>):</span>
        <span class=sd>&quot;&quot;&quot;</span>
<span class=sd>        Computes the Chebyshev Distance</span>
<span class=sd>        :param rating1: rating</span>
<span class=sd>        :param rating2: rating</span>
<span class=sd>        :return: distance if common ratings exists, or -1</span>
<span class=sd>        &quot;&quot;&quot;</span>
        <span class=n>distance</span> <span class=o>=</span> <span class=mi>0</span>
        <span class=n>commonRatings</span> <span class=o>=</span> <span class=bp>False</span>
        <span class=k>for</span> <span class=n>key</span> <span class=ow>in</span> <span class=n>rating1</span><span class=p>:</span>
            <span class=k>if</span> <span class=n>key</span> <span class=ow>in</span> <span class=n>rating2</span><span class=p>:</span>
                <span class=n>distance</span> <span class=o>=</span> <span class=nb>max</span><span class=p>(</span><span class=n>distance</span><span class=p>,</span> <span class=nb>abs</span><span class=p>(</span><span class=n>rating1</span><span class=p>[</span><span class=n>key</span><span class=p>]</span> <span class=o>-</span> <span class=n>rating2</span><span class=p>[</span><span class=n>key</span><span class=p>]))</span>
                <span class=n>commonRatings</span> <span class=o>=</span> <span class=bp>True</span>

        <span class=k>if</span> <span class=n>commonRatings</span><span class=p>:</span>
            <span class=k>return</span> <span class=n>distance</span>
        <span class=k>else</span><span class=p>:</span>
            <span class=k>return</span> <span class=o>-</span><span class=mi>1</span>  <span class=c1># Indicates no ratings in common</span>

    <span class=nd>@staticmethod</span>
    <span class=k>def</span> <span class=nf>pearson</span><span class=p>(</span><span class=n>rating1</span><span class=p>,</span> <span class=n>rating2</span><span class=p>):</span>
        <span class=sd>&quot;&quot;&quot;</span>
<span class=sd>        Compute pearson coefficient</span>
<span class=sd>        :param rating1: a dictionary</span>
<span class=sd>        :param rating2: a dictionary</span>
<span class=sd>        :return: pearson coefficient</span>
<span class=sd>        &quot;&quot;&quot;</span>
        <span class=n>sum_xy</span> <span class=o>=</span> <span class=mi>0</span>
        <span class=n>sum_x</span> <span class=o>=</span> <span class=mi>0</span>
        <span class=n>sum_y</span> <span class=o>=</span> <span class=mi>0</span>
        <span class=n>sum_x2</span> <span class=o>=</span> <span class=mi>0</span>
        <span class=n>sum_y2</span> <span class=o>=</span> <span class=mi>0</span>
        <span class=n>n</span> <span class=o>=</span> <span class=mi>0</span>
        <span class=n>commonRatings</span> <span class=o>=</span> <span class=bp>False</span>
        <span class=k>for</span> <span class=n>key</span> <span class=ow>in</span> <span class=n>rating1</span><span class=p>:</span>
            <span class=k>if</span> <span class=n>key</span> <span class=ow>in</span> <span class=n>rating2</span><span class=p>:</span>
                <span class=n>n</span> <span class=o>+=</span> <span class=mi>1</span>
                <span class=n>x</span> <span class=o>=</span> <span class=n>rating1</span><span class=p>[</span><span class=n>key</span><span class=p>]</span>
                <span class=n>y</span> <span class=o>=</span> <span class=n>rating2</span><span class=p>[</span><span class=n>key</span><span class=p>]</span>
                <span class=n>sum_xy</span> <span class=o>+=</span> <span class=n>x</span> <span class=o>*</span> <span class=n>y</span>
                <span class=n>sum_x</span> <span class=o>+=</span> <span class=n>x</span>
                <span class=n>sum_y</span> <span class=o>+=</span> <span class=n>y</span>
                <span class=n>sum_x2</span> <span class=o>+=</span> <span class=nb>pow</span><span class=p>(</span><span class=n>x</span><span class=p>,</span> <span class=mi>2</span><span class=p>)</span>
                <span class=n>sum_y2</span> <span class=o>+=</span> <span class=nb>pow</span><span class=p>(</span><span class=n>y</span><span class=p>,</span> <span class=mi>2</span><span class=p>)</span>
                <span class=n>commonRatings</span> <span class=o>=</span> <span class=bp>True</span>

        <span class=k>if</span> <span class=ow>not</span> <span class=n>commonRatings</span><span class=p>:</span>
            <span class=k>return</span> <span class=o>-</span><span class=mi>1</span>
        <span class=c1># now compute denominator</span>
        <span class=n>denominator</span> <span class=o>=</span> <span class=n>math</span><span class=o>.</span><span class=n>sqrt</span><span class=p>(</span><span class=n>sum_x2</span> <span class=o>-</span> <span class=nb>pow</span><span class=p>(</span><span class=n>sum_x</span><span class=p>,</span> <span class=mi>2</span><span class=p>)</span> <span class=o>/</span> <span class=n>n</span><span class=p>)</span>\ 
            <span class=o>*</span> <span class=n>math</span><span class=o>.</span><span class=n>sqrt</span><span class=p>(</span><span class=n>sum_y2</span> <span class=o>-</span> <span class=nb>pow</span><span class=p>(</span><span class=n>sum_y</span><span class=p>,</span> <span class=mi>2</span><span class=p>)</span> <span class=o>/</span> <span class=n>n</span><span class=p>)</span>
        <span class=k>if</span> <span class=n>denominator</span> <span class=o>==</span> <span class=mi>0</span><span class=p>:</span>
            <span class=k>return</span> <span class=mi>0</span>
        <span class=k>else</span><span class=p>:</span>
            <span class=k>return</span> <span class=p>(</span><span class=n>sum_xy</span> <span class=o>-</span> <span class=p>(</span><span class=n>sum_x</span> <span class=o>*</span> <span class=n>sum_y</span><span class=p>)</span> <span class=o>/</span> <span class=n>n</span><span class=p>)</span> <span class=o>/</span> <span class=n>denominator</span>
</pre></div></div><input name=tab-group-4 type=radio id=tab-group-4-2_python class=code-tab data-lang=python aria-controls=tab-group-4-2_python-panel role=tab><label for=tab-group-4-2_python class=code-tab-label data-lang=python id=tab-group-4-2_python-label>Books_import</label><div class=code-tabpanel role=tabpanel data-lang=python id=tab-group-4-2_python-panel aria-labelledby=tab-group-4-2_python-label><div class=codehilite><pre><span class=k>class</span> <span class=nc>BooksImport</span><span class=p>:</span>

    <span class=k>def</span> <span class=nf>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>books</span> <span class=o>=</span> <span class=p>{}</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>users</span> <span class=o>=</span> <span class=p>{}</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>book_ratings</span> <span class=o>=</span> <span class=p>{}</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>user_ratings</span> <span class=o>=</span> <span class=p>{}</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>bx_books_import</span><span class=p>()</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>bx_users_import</span><span class=p>()</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>bx_ratings_import</span><span class=p>()</span>

    <span class=k>def</span> <span class=nf>bx_books_import</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
        <span class=sd>&quot;&quot;&quot;</span>
<span class=sd>        import books meta information</span>
<span class=sd>        &quot;&quot;&quot;</span>

        <span class=k>try</span><span class=p>:</span>
            <span class=n>booksfile</span> <span class=o>=</span> <span class=n>codecs</span><span class=o>.</span><span class=n>open</span><span class=p>(</span><span class=s2>&quot;BX-Dump/BX-Books.csv&quot;</span><span class=p>,</span> <span class=s2>&quot;r&quot;</span><span class=p>,</span> <span class=s2>&quot;utf-8&quot;</span><span class=p>)</span>

            <span class=k>for</span> <span class=n>line</span> <span class=ow>in</span> <span class=n>booksfile</span><span class=p>:</span>
                <span class=n>props</span> <span class=o>=</span> <span class=n>line</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=s1>&#39;;&#39;</span><span class=p>)</span>
                <span class=n>isbn</span> <span class=o>=</span> <span class=n>props</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=o>.</span><span class=n>strip</span><span class=p>(</span><span class=s1>&#39;&quot;&#39;</span><span class=p>)</span>
                <span class=n>title</span> <span class=o>=</span> <span class=n>props</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span><span class=o>.</span><span class=n>strip</span><span class=p>(</span><span class=s1>&#39;&quot;&#39;</span><span class=p>)</span>
                <span class=n>author</span> <span class=o>=</span> <span class=n>props</span><span class=p>[</span><span class=mi>2</span><span class=p>]</span><span class=o>.</span><span class=n>strip</span><span class=p>(</span><span class=s1>&#39;&quot;&#39;</span><span class=p>)</span>
                <span class=n>year</span> <span class=o>=</span> <span class=n>props</span><span class=p>[</span><span class=mi>3</span><span class=p>]</span><span class=o>.</span><span class=n>strip</span><span class=p>(</span><span class=s1>&#39;&quot;&#39;</span><span class=p>)</span>
                <span class=bp>self</span><span class=o>.</span><span class=n>books</span><span class=p>[</span><span class=n>isbn</span><span class=p>]</span> <span class=o>=</span> <span class=p>{</span><span class=s2>&quot;title&quot;</span><span class=p>:</span> <span class=n>title</span><span class=p>,</span> <span class=s2>&quot;author&quot;</span><span class=p>:</span> <span class=n>author</span><span class=p>,</span> <span class=s2>&quot;year&quot;</span><span class=p>:</span> <span class=n>year</span><span class=p>}</span>

            <span class=n>booksfile</span><span class=o>.</span><span class=n>close</span><span class=p>()</span>

        <span class=k>except</span> <span class=ne>IOError</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
            <span class=n>error</span> <span class=o>=</span> <span class=s2>&quot;Failed to load: {0}&quot;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>e</span><span class=p>)</span>
            <span class=k>print</span><span class=p>(</span><span class=n>error</span><span class=p>)</span>

    <span class=k>def</span> <span class=nf>bx_users_import</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
        <span class=sd>&quot;&quot;&quot;</span>
<span class=sd>        import user meta information</span>
<span class=sd>        user is a dictionary, whose key is user_id</span>
<span class=sd>        &quot;&quot;&quot;</span>
        <span class=k>try</span><span class=p>:</span>
            <span class=n>users_file</span> <span class=o>=</span> <span class=n>codecs</span><span class=o>.</span><span class=n>open</span><span class=p>(</span><span class=s2>&quot;BX-Dump/BX-Users.csv&quot;</span><span class=p>,</span> <span class=s1>&#39;r&#39;</span><span class=p>,</span> <span class=s1>&#39;utf--8&#39;</span><span class=p>)</span>
            <span class=k>for</span> <span class=n>line</span> <span class=ow>in</span> <span class=n>users_file</span><span class=p>:</span>
                <span class=n>props</span> <span class=o>=</span> <span class=n>line</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=s1>&#39;;&#39;</span><span class=p>)</span>
                <span class=n>user_id</span> <span class=o>=</span> <span class=n>props</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=o>.</span><span class=n>strip</span><span class=p>(</span><span class=s1>&#39;&quot;&#39;</span><span class=p>)</span>
                <span class=n>location</span> <span class=o>=</span> <span class=n>props</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span><span class=o>.</span><span class=n>strip</span><span class=p>(</span><span class=s1>&#39;&quot;&#39;</span><span class=p>)</span>
                <span class=bp>self</span><span class=o>.</span><span class=n>users</span><span class=p>[</span><span class=n>user_id</span><span class=p>]</span> <span class=o>=</span> <span class=n>location</span>
                <span class=bp>self</span><span class=o>.</span><span class=n>user_ratings</span><span class=p>[</span><span class=n>user_id</span><span class=p>]</span> <span class=o>=</span> <span class=p>{}</span>
            <span class=n>users_file</span><span class=o>.</span><span class=n>close</span><span class=p>()</span>

        <span class=k>except</span> <span class=ne>IOError</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
            <span class=n>error</span> <span class=o>=</span> <span class=s2>&quot;Failed to load: {0}&quot;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>e</span><span class=p>)</span>
            <span class=k>print</span><span class=p>(</span><span class=n>error</span><span class=p>)</span>

    <span class=k>def</span> <span class=nf>bx_ratings_import</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
        <span class=k>try</span><span class=p>:</span>
            <span class=n>ratings_file</span> <span class=o>=</span> <span class=n>codecs</span><span class=o>.</span><span class=n>open</span><span class=p>(</span><span class=s2>&quot;BX-Dump/BX-Book-Ratings.csv&quot;</span><span class=p>,</span> <span class=s1>&#39;r&#39;</span><span class=p>,</span> <span class=s1>&#39;utf--8&#39;</span><span class=p>)</span>
            <span class=k>for</span> <span class=n>line</span> <span class=ow>in</span> <span class=n>ratings_file</span><span class=p>:</span>
                <span class=n>props</span> <span class=o>=</span> <span class=n>line</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=s1>&#39;;&#39;</span><span class=p>)</span>
                <span class=n>user_id</span> <span class=o>=</span> <span class=n>props</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=o>.</span><span class=n>strip</span><span class=p>(</span><span class=s1>&#39;&quot;&#39;</span><span class=p>)</span>
                <span class=n>book_id</span> <span class=o>=</span> <span class=n>props</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span><span class=o>.</span><span class=n>strip</span><span class=p>(</span><span class=s1>&#39;&quot;&#39;</span><span class=p>)</span>
                <span class=n>rating</span> <span class=o>=</span> <span class=nb>int</span><span class=p>(</span><span class=n>props</span><span class=p>[</span><span class=mi>2</span><span class=p>]</span><span class=o>.</span><span class=n>strip</span><span class=p>()</span><span class=o>.</span><span class=n>strip</span><span class=p>(</span><span class=s1>&#39;&quot;&#39;</span><span class=p>))</span>

                <span class=k>if</span> <span class=n>book_id</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>book_ratings</span><span class=p>:</span>
                    <span class=bp>self</span><span class=o>.</span><span class=n>book_ratings</span><span class=p>[</span><span class=n>book_id</span><span class=p>]</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>rating</span><span class=p>)</span>
                <span class=k>else</span><span class=p>:</span>
                    <span class=bp>self</span><span class=o>.</span><span class=n>book_ratings</span><span class=p>[</span><span class=n>book_id</span><span class=p>]</span> <span class=o>=</span> <span class=p>[</span><span class=n>rating</span><span class=p>]</span>

                <span class=bp>self</span><span class=o>.</span><span class=n>user_ratings</span><span class=p>[</span><span class=n>user_id</span><span class=p>][</span><span class=n>book_id</span><span class=p>]</span> <span class=o>=</span> <span class=n>rating</span>

            <span class=n>ratings_file</span><span class=o>.</span><span class=n>close</span><span class=p>()</span>

        <span class=k>except</span> <span class=ne>IOError</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
            <span class=n>error</span> <span class=o>=</span> <span class=s2>&quot;Failed to load: {0}&quot;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>e</span><span class=p>)</span>
            <span class=k>print</span><span class=p>(</span><span class=n>error</span><span class=p>)</span>

    <span class=k>def</span> <span class=nf>get_books</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
        <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>books</span>

    <span class=k>def</span> <span class=nf>get_users</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
        <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>users</span>

    <span class=k>def</span> <span class=nf>get_user_ratings</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
        <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>user_ratings</span>

    <span class=k>def</span> <span class=nf>get_book_ratings</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
        <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>book_ratings</span>

    <span class=k>def</span> <span class=nf>recommender_import</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
        <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>books</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>users</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>user_ratings</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>book_ratings</span>
</pre></div></div></div></div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script>
            var base_url = "../..",
                shortcuts = {"search": 83, "next": 78, "help": 191, "previous": 80};
        </script>
        <script src="../../js/base.js" defer></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" defer></script>
        <script src="../../extra_javascript/tabhack.js" defer></script>
        <script src="../../search/main.js" defer></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="Search Modal" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                <h4 class="modal-title" id="exampleModalLabel">Search</h4>
            </div>
            <div class="modal-body">
                <p>
                    From here you can search these documents. Enter
                    your search terms below.
                </p>
                <form role="form">
                    <div class="form-group">
                        <input type="text" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="Keyboard Shortcuts Modal" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                <h4 class="modal-title" id="exampleModalLabel">Keyboard Shortcuts</h4>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
