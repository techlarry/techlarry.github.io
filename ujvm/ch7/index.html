<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        <meta name="author" content="Zhenhua Wang">
        <link rel="canonical" href="http://larryim.cc/note/ujvm/ch7/">
        <link rel="shortcut icon" href="../../img/favicon.ico">
        <title>Chapter 7 : 虚拟机类加载机制 - Zhenhua's Notes</title>
        <link href="../../css/bootstrap-custom.min.css" rel="stylesheet">
        <link href="../../css/font-awesome-4.5.0.css" rel="stylesheet">
        <link href="../../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="../../css/highlight.css">
        <link href="../../extra_css/custom.css" rel="stylesheet">
        <link href="../../extra_css/custom.js" rel="stylesheet">
        <link href="../../extra_css/friendly.css" rel="stylesheet">
        <link href="../../extra_css/theme.css" rel="stylesheet">
        <link href="../../extra_css/mkdocs/js/lunr-0.5.7.min.js" rel="stylesheet">
        <link href="../../extra_css/mkdocs/js/mustache.min.js" rel="stylesheet">
        <link href="../../extra_css/mkdocs/js/require.js" rel="stylesheet">
        <link href="../../extra_css/mkdocs/js/search.js" rel="stylesheet">
        <link href="../../extra_css/mkdocs/js/text.js" rel="stylesheet">
        <link href="../../extra_css/code-tab.css" rel="stylesheet">
        <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->

        <script src="../../js/jquery-1.10.2.min.js"></script>
        <script src="../../js/bootstrap-3.0.3.min.js"></script>
        <script src="../../js/highlight.pack.js"></script> 
    </head>

    <body>

        <div class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">

        <!-- Collapsed navigation -->
        <div class="navbar-header">
            <!-- Expander button -->
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="../..">Zhenhua's Notes</a>
        </div>

        <!-- Expanded navigation -->
        <div class="navbar-collapse collapse">
                <!-- Main navigation -->
                <ul class="nav navbar-nav">
                    <li >
                        <a href="../..">Home</a>
                    </li>
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">OSC <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                            
<li >
    <a href="../../osc/">Contents</a>
</li>
                            
<li >
    <a href="../../osc/ch1/">Chapter 1: Introduction </a>
</li>
                            
<li >
    <a href="../../osc/ch2/">Chapter 2: Operating System structures</a>
</li>
                            
<li >
    <a href="../../osc/ch3/">Chapter 3: Processes</a>
</li>
                            
<li >
    <a href="../../osc/ch4/">Chapter 4: Threads and Concurrency</a>
</li>
                            
<li >
    <a href="../../osc/ch5/">Chapter 5: CPU Scheduling</a>
</li>
                            
<li >
    <a href="../../osc/ch6/">Chapter 6: Synchronization Tools</a>
</li>
                            
<li >
    <a href="../../osc/ch7/">Chapter 7: Synchronization Examples</a>
</li>
                            
<li >
    <a href="../../osc/ch8/">Chapter 8: Deadlocks</a>
</li>
                            
<li >
    <a href="../../osc/ch9/">Chapter 9: Main Memory</a>
</li>
                            
<li >
    <a href="../../osc/ch10/">Chapter 10: Virtual Memory</a>
</li>
                            
<li >
    <a href="../../osc/ch11/">Chapter 11: Mass-Storage Structure</a>
</li>
                            
<li >
    <a href="../../osc/ch13/">Chapter 13: File-System Interfaces</a>
</li>
                        </ul>
                    </li>
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">CSAPP <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                            
<li >
    <a href="../../csapp/">Contents</a>
</li>
                            
<li >
    <a href="../../csapp/ch1/">Chapter 1: 计算机系统漫游</a>
</li>
                            
<li >
    <a href="../../csapp/ch2/">Chapter 2: 信息的表示和处理</a>
</li>
                            
<li >
    <a href="../../csapp/ch3/">Chapter 3: 程序的机器级表示</a>
</li>
                            
<li >
    <a href="../../csapp/ch4/">Chapter 4: 处理器体系结构</a>
</li>
                            
<li >
    <a href="../../csapp/ch5/">Chapter 5: 优化程序性能</a>
</li>
                            
<li >
    <a href="../../csapp/ch6/">Chapter 6: 存储器层次结构</a>
</li>
                            
<li >
    <a href="../../csapp/ch7/">Chapter 7: 链接</a>
</li>
                            
<li >
    <a href="../../csapp/ch8/">Chapter 8: 异常控制流</a>
</li>
                            
<li >
    <a href="../../csapp/ch9/">Chapter 9: 虚拟内存</a>
</li>
                            
<li >
    <a href="../../csapp/ch10/">Chapter 10: 系统级I/O</a>
</li>
                            
<li >
    <a href="../../csapp/ch11/">Chapter 11: 网络编程</a>
</li>
                        </ul>
                    </li>
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">HFJ <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                            
<li >
    <a href="../../hfj/">Contents</a>
</li>
                            
<li >
    <a href="../../hfj/ch1/">Chapter 1: Dive in A Quick Dip</a>
</li>
                            
<li >
    <a href="../../hfj/ch2/">Chapter 2: Classes and Objects</a>
</li>
                            
<li >
    <a href="../../hfj/ch3/">Chapter 3: Primitives and References</a>
</li>
                            
<li >
    <a href="../../hfj/ch4/">Chapter 4: Methods use Instance Variables</a>
</li>
                            
<li >
    <a href="../../hfj/ch5/">Chapter 5: Writing a Program</a>
</li>
                            
<li >
    <a href="../../hfj/ch6/">Chapter 6: Get to Know the Java API</a>
</li>
                            
<li >
    <a href="../../hfj/ch7/">Chapter 7: Inheritance and Polymorphism</a>
</li>
                            
<li >
    <a href="../../hfj/ch8/">Chapter 8: Interfaces and Abstract Classes</a>
</li>
                            
<li >
    <a href="../../hfj/ch9/">Chapter 9: Constructors and Garbage Collection</a>
</li>
                            
<li >
    <a href="../../hfj/ch10/">Chapter 10: Numbers and Statics</a>
</li>
                            
<li >
    <a href="../../hfj/ch11/">Chapter 11: Exception Handling</a>
</li>
                            
<li >
    <a href="../../hfj/ch12/">Chapter 12: Getting GUI</a>
</li>
                            
<li >
    <a href="../../hfj/ch13/">Chapter 13: Using Swing</a>
</li>
                            
<li >
    <a href="../../hfj/ch14/">Chapter 14: Serialization and File I/O</a>
</li>
                            
<li >
    <a href="../../hfj/ch15/">Chapter 15: Networking and Threads</a>
</li>
                            
<li >
    <a href="../../hfj/ch16/">Chapter 16: Collections and Generics</a>
</li>
                            
<li >
    <a href="../../hfj/ch17/">Chapter 17: Packages, Jars and Deployment</a>
</li>
                            
<li >
    <a href="../../hfj/ch18/">Chapter 18: Remote deploy with RMI</a>
</li>
                            
<li >
    <a href="../../hfj/Appendix/">Appendix: The Top Ten Topics</a>
</li>
                        </ul>
                    </li>
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">HFDP <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                            
<li >
    <a href="../../hfdp/">Contents</a>
</li>
                            
<li >
    <a href="../../hfdp/ch1/">Chapter 1: Strategy Pattern </a>
</li>
                            
<li >
    <a href="../../hfdp/ch2/">Chapter 2: Observer Pattern</a>
</li>
                            
<li >
    <a href="../../hfdp/ch3/">Chapter 3: Decorator Pattern </a>
</li>
                            
<li >
    <a href="../../hfdp/ch4/">Chapter 4: Factory Pattern</a>
</li>
                            
<li >
    <a href="../../hfdp/ch5/">Chapter 5: Singleton Pattern</a>
</li>
                            
<li >
    <a href="../../hfdp/ch6/">Chapter 6: Command Pattern</a>
</li>
                            
<li >
    <a href="../../hfdp/ch7/">Chapter 7: Adapter and Facade Patterns</a>
</li>
                            
<li >
    <a href="../../hfdp/ch8/">Chapter 8: Template Method Pattern</a>
</li>
                            
<li >
    <a href="../../hfdp/ch9/">Chapter 9: Iterator and Composite Patterns</a>
</li>
                            
<li >
    <a href="../../hfdp/ch10/">Chapter 10: State Pattern</a>
</li>
                            
<li >
    <a href="../../hfdp/ch11/">Chapter 11: Proxy Pattern</a>
</li>
                            
<li >
    <a href="../../hfdp/ch12/">Chapter 12: Compound Pattern</a>
</li>
                            
<li >
    <a href="../../hfdp/ch13/">Chapter 13: Better Living with Patterns</a>
</li>
                        </ul>
                    </li>
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">TIJ <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                            
<li >
    <a href="../../tij/">Contents</a>
</li>
                            
<li >
    <a href="../../tij/ch1/">Chapter 1: Introduction</a>
</li>
                            
<li >
    <a href="../../tij/ch2/">Chapter 2: Introduction to Objects</a>
</li>
                            
<li >
    <a href="../../tij/ch3/">Chapter 3: Everything is an Object</a>
</li>
                            
<li >
    <a href="../../tij/ch4/">Chapter 4: Opertors</a>
</li>
                            
<li >
    <a href="../../tij/ch5/">Chapter 5: Controlling Execution</a>
</li>
                            
<li >
    <a href="../../tij/ch6/">Chapter 6: Initialization & Cleanup</a>
</li>
                            
<li >
    <a href="../../tij/ch7/">Chapter 7: Access Control</a>
</li>
                            
<li >
    <a href="../../tij/ch8/">Chapter 8: Reusing Clases</a>
</li>
                            
<li >
    <a href="../../tij/ch9/">Chapter 9: Polymorphism</a>
</li>
                            
<li >
    <a href="../../tij/ch10/">Chapter 10: Interfaces</a>
</li>
                            
<li >
    <a href="../../tij/ch11/">Chapter 11: Inner Classes</a>
</li>
                            
<li >
    <a href="../../tij/ch12/">Chapter 12: Holding Your Objects</a>
</li>
                            
<li >
    <a href="../../tij/ch13/">Chapter 13: Error Handling with Exceptions</a>
</li>
                            
<li >
    <a href="../../tij/ch14/">Chapter 14: Strings</a>
</li>
                            
<li >
    <a href="../../tij/ch15/">Chapter 15: Type Information</a>
</li>
                            
<li >
    <a href="../../tij/ch16/">Chapter 16: Generics</a>
</li>
                            
<li >
    <a href="../../tij/ch17/">Chapter 17: Arrays</a>
</li>
                            
<li >
    <a href="../../tij/ch18/">Chapter 18: Containers in Depth</a>
</li>
                            
<li >
    <a href="../../tij/ch19/">Chapter 19: I/O</a>
</li>
                            
<li >
    <a href="../../tij/ch20/">Chapter 20: Enumerated Types</a>
</li>
                            
<li >
    <a href="../../tij/ch21/">Chapter 21: Annotations</a>
</li>
                            
<li >
    <a href="../../tij/ch22/">Chapter 22: Concurrency</a>
</li>
                            
<li >
    <a href="../../tij/ch23/">Chapter 23: Graphical User Interfaces</a>
</li>
                        </ul>
                    </li>
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">CPJ <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                            
<li >
    <a href="../../cpj/">Contents</a>
</li>
                            
<li >
    <a href="../../cpj/ch1/">Concurrent Programming in Java 1: Threads and Locks</a>
</li>
                            
<li >
    <a href="../../cpj/ch2/">Concurrent Programming in Java 2: Critical Sections and Isolation</a>
</li>
                            
<li >
    <a href="../../cpj/ch3/">Concurrent Programming in Java 3: Actors</a>
</li>
                            
<li >
    <a href="../../cpj/ch4/">Concurrent Programming in Java 4: Concurrent Data Structures</a>
</li>
                        </ul>
                    </li>
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">HADOOP <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                            
<li >
    <a href="../../hadoop/">Contents</a>
</li>
                            
<li >
    <a href="../../hadoop/ch1/">Chapter 1: Meet Hadoop</a>
</li>
                            
<li >
    <a href="../../hadoop/ch2/">Chapter 2: MapReduce</a>
</li>
                            
<li >
    <a href="../../hadoop/ch3/">Chapter 3: The Hadoop Distributed FileSystem</a>
</li>
                            
<li >
    <a href="../../hadoop/ch4/">Chapter 4: YARN</a>
</li>
                            
<li >
    <a href="../../hadoop/ch5/">Chapter 5: Hadoop I/O</a>
</li>
                            
<li >
    <a href="../../hadoop/ch6/">Chapter 6: Developing a MapReduce Application</a>
</li>
                            
<li >
    <a href="../../hadoop/ch7/">Chapter 7: How MapReduce Works</a>
</li>
                            
<li >
    <a href="../../hadoop/ch8/">Chapter 8: MapReduce Types and Formats</a>
</li>
                            
<li >
    <a href="../../hadoop/ch9/">Chapter 9: MapReduce Features</a>
</li>
                            
<li >
    <a href="../../hadoop/ch10/">Chapter 10: Setting Up a Hadoop Cluster</a>
</li>
                            
<li >
    <a href="../../hadoop/ch11/">Chapter 11: Adminstering Hadoop</a>
</li>
                            
<li >
    <a href="../../hadoop/ch12/">Chapter 12: Avro</a>
</li>
                            
<li >
    <a href="../../hadoop/ch13/">Chapter 13: Parquet</a>
</li>
                            
<li >
    <a href="../../hadoop/ch14/">Chapter 14: Flume</a>
</li>
                            
<li >
    <a href="../../hadoop/ch15/">Chapter 15: Sqoop</a>
</li>
                            
<li >
    <a href="../../hadoop/ch16/">Chapter 16: Pig</a>
</li>
                            
<li >
    <a href="../../hadoop/ch17/">Chapter 17: Hive</a>
</li>
                            
<li >
    <a href="../../hadoop/ch18/">Chapter 18: Crunch</a>
</li>
                            
<li >
    <a href="../../hadoop/ch19/">Chapter 19: Spark</a>
</li>
                            
<li >
    <a href="../../hadoop/ch20/">Chapter 20: HBase</a>
</li>
                            
<li >
    <a href="../../hadoop/ch21/">Chapter 21: ZooKeeper</a>
</li>
                            
<li >
    <a href="../../hadoop/ch22/">Chapter 22: Composable Data at Center</a>
</li>
                            
<li >
    <a href="../../hadoop/ch23/">Chapter 23: Biological Data Science: Saving Lives with Software</a>
</li>
                            
<li >
    <a href="../../hadoop/ch24/">Chapter 24: Cascading</a>
</li>
                        </ul>
                    </li>
                    <li class="dropdown active">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">UJVM <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                            
<li >
    <a href="../">Contents</a>
</li>
                            
<li >
    <a href="../ch1/">Chapter 1 : 走进Java</a>
</li>
                            
<li >
    <a href="../ch2/">Chapter 2 : Java内存区域与内存溢出正常</a>
</li>
                            
<li >
    <a href="../ch3/">Chapter 3 : 垃圾收集器与内存分配策略</a>
</li>
                            
<li >
    <a href="../ch4/">Chapter 4 : 虚拟机性能监控与故障处理工具</a>
</li>
                            
<li >
    <a href="../ch5/">Chapter 5 : 调优案例分析与实战</a>
</li>
                            
<li >
    <a href="../ch6/">Chapter 6 : 类文件结构</a>
</li>
                            
<li class="active">
    <a href="./">Chapter 7 : 虚拟机类加载机制</a>
</li>
                            
<li >
    <a href="../ch8/">Chapter 8 : 虚拟机字节码执行引擎</a>
</li>
                            
<li >
    <a href="../ch9/">Chapter 9 : 类加载及执行子系统的案例与实战</a>
</li>
                            
<li >
    <a href="../ch10/">Chapter 10 : 早期(编译期)优化</a>
</li>
                            
<li >
    <a href="../ch11/">Chapter 11 : 晚期(运行期)优化</a>
</li>
                            
<li >
    <a href="../ch12/">Chapter 12 : Java内存模型与线程</a>
</li>
                            
<li >
    <a href="../ch13/">Chapter 13 : 线程安全与锁优化</a>
</li>
                            
<li >
    <a href="../AppendixC/">Appendix HotSpot虚拟机主要参数列表</a>
</li>
                        </ul>
                    </li>
                    <li >
                        <a href="../../books/">Books</a>
                    </li>
                </ul>

            <ul class="nav navbar-nav navbar-right">
                <li>
                    <a href="#" data-toggle="modal" data-target="#mkdocs_search_modal">
                        <i class="fa fa-search"></i> Search
                    </a>
                </li>
                    <li >
                        <a rel="next" href="../ch6/">
                            <i class="fa fa-arrow-left"></i> Previous
                        </a>
                    </li>
                    <li >
                        <a rel="prev" href="../ch8/">
                            Next <i class="fa fa-arrow-right"></i>
                        </a>
                    </li>
            </ul>
        </div>
    </div>
</div>

        <div class="container">
                <div class="col-md-3"><div class="bs-sidebar hidden-print affix well" role="complementary">
    <ul class="nav bs-sidenav">
        <li class="main active"><a href="#java-7-">深入理解Java虚拟机 7 - 虚拟机类加载机制</a></li>
        <li class="main "><a href="#1">1 概述</a></li>
        <li class="main "><a href="#2">2 类加载的时机</a></li>
        <li class="main "><a href="#3">3 类加载的过程</a></li>
            <li><a href="#_1">加载</a></li>
            <li><a href="#_2">验证</a></li>
            <li><a href="#_3">准备</a></li>
            <li><a href="#_4">解析</a></li>
            <li><a href="#_5">初始化</a></li>
        <li class="main "><a href="#4">4 类加载器</a></li>
            <li><a href="#_6">类与类加载器</a></li>
            <li><a href="#_7">双亲委派模型</a></li>
    </ul>
</div></div>
                <div class="col-md-9" role="main">

<h3 id="java-7-"><strong>深入理解Java虚拟机 7 - 虚拟机类加载机制</strong><a class="headerlink" href="#java-7-" title="Permanent link">&para;</a></h3>
<h3 id="1">1 概述<a class="headerlink" href="#1" title="Permanent link">&para;</a></h3>
<p>虚拟机的类加载机制是指，虚拟机把描述类的数据从Class⽂件加载到内存，并对数据进⾏校验、 转换解析和初始化，最终形成可以被虚拟机直接使⽤的Java类型。</p>
<p>与那些在编译时需要进⾏链接的语⾔不同，在Java语⾔⾥⾯，类型的加载、链接和初始化过程都是在程序运⾏期间完成的，这种策略虽然会令类加载时稍微增加⼀些性能开销，但是会为Java应⽤程序提供⾼度的灵活性，Java⾥天⽣可以动态扩展的语⾔特性就是依赖运⾏期动态加载和动态链接这个特点实现的。</p>
<h3 id="2">2 类加载的时机<a class="headerlink" href="#2" title="Permanent link">&para;</a></h3>
<p>类从被加载到虚拟机内存中开始，到卸载出内存为⽌，它的整个⽣命周期包括：加载(Loading)、验证(Verification)、准备(Preparation)、解析(Resolution)、初始化(Initialization)、使⽤(Using)和卸载(Unloading)7个阶段。</p>
<p><img alt="" src="../figures/类加载过程.png" /></p>
<p>对于初始化阶段，虚拟机规范严格规定了有且只有5种情况必须⽴即对类进⾏“初始化”：</p>
<ul>
<li>遇到<C>new<C>、<C>getstatic<C>、<C>putstatic<C>或<C>invokestatic</C>这4条字节码指令时，如果类没有进⾏过初始化，则需要先触发其初始化。⽣成这4条指令的最常见的Java代码场景是：使⽤<C>new</C>关键字实例化对象的时候、读取或设置⼀个类的静态字段(被final修饰、已在编译期把结果放⼊常量池的静态字段除外)的时候，以及调⽤⼀个类的静态⽅法的时候。</li>
<li>使⽤<C>java.lang.reflect</C>包的⽅法对类进⾏反射调⽤的时候，如果类没有进⾏过初始化，则需要先触发其初始化。</li>
<li>当初始化⼀个类的时候，如果发现其⽗类还没有进⾏过初始化，则需要先触发其⽗类的初始化。</li>
<li>当虚拟机启动时，⽤户需要指定⼀个要执⾏的主类(包含<C>main()</C>⽅法的那个类)，虚拟机会先初始化这个主类。</li>
<li>当使⽤JDK 1.7的动态语⾔⽀持时，如果⼀个<C>java.lang.invoke.MethodHandle</C>实例最后的解析结果REF_getStatic、 REF_putStatic、REF_invokeStatic的⽅法句柄，并且这个⽅法句柄所对应的类没有进⾏过初始化，则需要先触发其初始化。</li>
</ul>
<p>"有且只有"这5种场景中的⾏为称为对⼀个类进⾏<strong>主动引⽤</strong>。除此之外，所有引⽤类的⽅式都不会触发初始化，称为<strong>被动引⽤</strong>。</p>
<p>上述代码运⾏之后，只会输出"SuperClass init!"，⽽不会输 出"SubClass init!"。可通过<C>-Xlog:class+load=info</C>打印类加载信息。</p>
<div class=md-fenced-code-tabs id=tab-tab-group-0><input name=tab-group-0 type=radio id=tab-group-0-0_Java checked=checked class=code-tab data-lang=Java aria-controls=tab-group-0-0_Java-panel role=tab><label for=tab-group-0-0_Java class=code-tab-label data-lang=Java id=tab-group-0-0_Java-label>Java</label><div class=code-tabpanel role=tabpanel data-lang=Java id=tab-group-0-0_Java-panel aria-labelledby=tab-group-0-0_Java-label><div class=codehilite><pre><span class=c1>//被动使用类字段演示一：通过子类引用父类的静态字段，不会导致子类初始化</span>
<span class=kd>public</span> <span class=kd>class</span> <span class=nc>NotInitialization1</span> <span class=o>{</span>
    <span class=kd>public</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>main</span><span class=o>(</span><span class=n>String</span><span class=o>[]</span> <span class=n>args</span><span class=o>)</span> <span class=o>{</span>
        <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=n>SubClass</span><span class=o>.</span><span class=na>value</span><span class=o>);</span>
    <span class=o>}</span>
<span class=o>}</span>

<span class=kd>class</span> <span class=nc>SuperClass</span> <span class=o>{</span>
    <span class=kd>static</span> <span class=o>{</span>
        <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=s>&quot;SuperClass init!&quot;</span><span class=o>);</span>
    <span class=o>}</span>
    <span class=kd>public</span> <span class=kd>static</span> <span class=kt>int</span> <span class=n>value</span> <span class=o>=</span> <span class=mi>123</span><span class=o>;</span>
<span class=o>}</span>

<span class=kd>class</span> <span class=nc>SubClass</span> <span class=kd>extends</span> <span class=n>SuperClass</span> <span class=o>{</span>
    <span class=kd>static</span> <span class=o>{</span>
        <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=s>&quot;SubClass init!&quot;</span><span class=o>);</span>
    <span class=o>}</span>
<span class=o>}</span>
</pre></div></div><input name=tab-group-0 type=radio id=tab-group-0-1_Java class=code-tab data-lang=Java aria-controls=tab-group-0-1_Java-panel role=tab><label for=tab-group-0-1_Java class=code-tab-label data-lang=Java id=tab-group-0-1_Java-label>Java</label><div class=code-tabpanel role=tabpanel data-lang=Java id=tab-group-0-1_Java-panel aria-labelledby=tab-group-0-1_Java-label><div class=codehilite><pre><span class=c1>// 被动使用类字段演示二：通过数组定义来引用类，不会触发此类的初始化</span>
<span class=kd>public</span> <span class=kd>class</span> <span class=nc>NotInitialization2</span>  <span class=o>{</span>
    <span class=kd>public</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>main</span><span class=o>(</span><span class=n>String</span><span class=o>[]</span> <span class=n>args</span><span class=o>)</span> <span class=o>{</span>
        <span class=n>SuperClass</span><span class=o>[]</span> <span class=n>sca</span> <span class=o>=</span> <span class=k>new</span> <span class=n>SuperClass</span><span class=o>[</span><span class=mi>10</span><span class=o>];</span>
    <span class=o>}</span>
<span class=o>}</span>
</pre></div></div></div>

<h3 id="3">3 类加载的过程<a class="headerlink" href="#3" title="Permanent link">&para;</a></h3>
<h4 id="_1">加载<a class="headerlink" href="#_1" title="Permanent link">&para;</a></h4>
<p><strong>Loading</strong> is the process of finding the class file that represents the class or interface type with a particular name and reading it into a byte array. Next the bytes are parsed to confirm they represent a Class object and have the correct major and minor versions. Any class or interface named as a direct superclass is also loaded. Once this is completed a class or interface object is created from the binary representation.</p>
<p>加载是类加载(Class Loading)过程的⼀个阶段，虚拟机需要完成以下3件事情：</p>
<ul>
<li>通过⼀个类的全限定名来获取定义此类的⼆进制字节流。</li>
<li>将这个字节流所代表的静态存储结构转化为⽅法区的运⾏时数据结构。</li>
<li>在内存中⽣成⼀个代表这个类的<C>java.lang.Class</C>对象，作为⽅法区这个类的各种数据的访问⼊口。</li>
</ul>
<p>第一条中的获取二进制字节流可以从多个地方获取。例如ZIP包(JAR)，网络(Applet)，运行时计算生成(<C>java.lang.refelct.Proxy</C>)等。</p>
<h4 id="_2">验证<a class="headerlink" href="#_2" title="Permanent link">&para;</a></h4>
<p>验证是为了确保Class⽂件的字节流中包含的信息符合当前虚拟机的要求，并且不会危害虚拟机⾃⾝的安全。</p>
<p>虽然Java语⾔本⾝是相对安全的语⾔，但是Class⽂件并不⼀定要求⽤Java编译⽽来，它可以使⽤任何途径产⽣，甚⾄包括⽤⼗六进制编辑器直接编写来产⽣Class⽂件。虚拟机如果不检查输 ⼊的字节流，对其完全信任的话，很可能会因为载⼊了有害的字节流⽽导致系统崩溃。</p>
<ul>
<li>⽂件格式验证：验证字节流是否符合Class⽂件格式的规范，并且能被当前 版本的虚拟机处理。</li>
<li>元数据验证：对字节码描述的信息进⾏语义分析，以保证其描述的信息符合Java语⾔规范的要求，</li>
</ul>
<h4 id="_3">准备<a class="headerlink" href="#_3" title="Permanent link">&para;</a></h4>
<p>Preparing involves allocation of memory for static storage and any data structures used by the JVM such as method tables. Static fields are created and initialized to their default values, however, no initializers or code is executed at this stage as that happens as part of initialization.</p>
<p>准备阶段为类变量分配内存并设置类变量(仅包括被被static修饰的变量)初始值，这些变量所使⽤的内存都将在⽅法区中进⾏分配。实力变量将会在对象实例化时随着对象一起分配在Java堆中。初始值通常情况下是数据类型的默认值.</p>
<p> <div class=codehilite><pre><span class=kd>public</span> <span class=kd>static</span> <span class=kt>int</span> <span class=n>value</span> <span class=o>=</span> <span class=mi>123</span><span class=o>;</span> <span class=c1>//初始值为0</span>
</pre></div></p>
<p>如果类字段的字段属性表中存在ConstantValue属性，那在准备阶段变量value就会被初始化为ConstantValue属性所指定的值：</p>
<p> <div class=codehilite><pre><span class=kd>public</span> <span class=kd>static</span> <span class=kd>final</span> <span class=kt>int</span> <span class=n>value</span> <span class=o>=</span> <span class=mi>123</span><span class=o>;</span> <span class=c1>// 初始值为123</span>
</pre></div></p>
<h4 id="_4">解析<a class="headerlink" href="#_4" title="Permanent link">&para;</a></h4>
<p>解析阶段将常量池内的符号引⽤替换为直接引⽤。</p>
<p><strong>符号引⽤</strong>(Symbolic References):符号引⽤以⼀组符号来描述所引⽤的⽬标，符号可以是任何形式的字⾯量，只要使⽤时能⽆歧义地定位到⽬标即可。符号引⽤与虚拟机实现的内存布局⽆关，引⽤的⽬标并不⼀定已经加载到内存中。各种虚拟机实现的内存布局可以各不相同，但是它们能接受的符号引⽤必须都是⼀致的，因为符号引⽤的字⾯量形式明确定义 在Java虚拟机规范的Class⽂件格式中。</p>
<p><strong>直接引⽤</strong>(Direct References): 直接引⽤可以是直接指向⽬标的指针、相对偏移量或是⼀个能间接定位到⽬标的句柄。直接引⽤是和虚拟机实现的内存布局相关的，同⼀个符号引⽤在不同虚拟机实例上翻译出来的直接引⽤⼀般不会相同。如果有了直接引⽤，那引⽤的⽬标必定已经在内 存中存在。</p>
<h4 id="_5">初始化<a class="headerlink" href="#_5" title="Permanent link">&para;</a></h4>
<p>Initialization of a class or interface consists of executing the class or interface initialization method &lt;<C>clinit</C>&gt;.</p>
<p>What is the difference between &lt;<C>init</C>&gt; and &lt;<C>clinit</C>&gt;? <a href="https://stackoverflow.com/questions/8517121/java-what-is-the-difference-between-init-and-clinit">StackOverflow</a></p>
<ul>
<li>&lt;<C>init</C>&gt; is the (or one of the) constructor(s) for the instance, and non-static field initialization.</li>
<li>&lt;<C>clinit</C>&gt; are the static initialization blocks for the class, and static field initialization.</li>
</ul>
<p> <div class=codehilite><pre><span class=kd>class</span> <span class=nc>X</span> <span class=o>{</span>

   <span class=kd>static</span> <span class=n>Log</span> <span class=n>log</span> <span class=o>=</span> <span class=n>LogFactory</span><span class=o>.</span><span class=na>getLog</span><span class=o>();</span> <span class=c1>// &lt;clinit&gt;</span>

   <span class=kd>private</span> <span class=kt>int</span> <span class=n>x</span> <span class=o>=</span> <span class=mi>1</span><span class=o>;</span>   <span class=c1>// &lt;init&gt;</span>

   <span class=n>X</span><span class=o>(){</span>
      <span class=c1>// &lt;init&gt;</span>
   <span class=o>}</span>

   <span class=kd>static</span> <span class=o>{</span>
      <span class=c1>// &lt;clinit&gt;</span>
   <span class=o>}</span>
<span class=o>}</span>
</pre></div></p>
<h3 id="4">4 类加载器<a class="headerlink" href="#4" title="Permanent link">&para;</a></h3>
<h4 id="_6">类与类加载器<a class="headerlink" href="#_6" title="Permanent link">&para;</a></h4>
<p>对于任意⼀个类，都需要由加载它的类加载器和这个类本⾝⼀同确⽴其在Java虚拟机中的唯⼀性，每⼀个类加载器， 都拥有⼀个独⽴的类名称空间。</p>
<p>⽐较两个类是否“相等”，只有在这两个类是由同⼀个类加载器加载的前提下才有意义，否则，即使这两个类来源于同⼀个Class⽂件，被同⼀个虚拟机加载，只要加载它们的类加载器不同，那这两个类就必定不相等。</p>
<p>不同的类加载器对<C>instanceof</C>关键字运算的结果的影响：</p>
<p> <div class=codehilite><pre><span class=kn>import</span> <span class=nn>java.io.IOException</span><span class=o>;</span>
<span class=kn>import</span> <span class=nn>java.io.InputStream</span><span class=o>;</span>

<span class=c1>//类加载器与instanceof关键字演示</span>
<span class=kd>public</span> <span class=kd>class</span> <span class=nc>ClassLoaderTest</span> <span class=o>{</span>
    <span class=kd>public</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>main</span><span class=o>(</span><span class=n>String</span><span class=o>[]</span> <span class=n>args</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>Exception</span> <span class=o>{</span>
        <span class=n>ClassLoader</span> <span class=n>myLoader</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ClassLoader</span><span class=o>()</span> <span class=o>{</span>
            <span class=nd>@Override</span>
            <span class=kd>public</span> <span class=n>Class</span><span class=o>&lt;?&gt;</span> <span class=n>loadClass</span><span class=o>(</span><span class=n>String</span> <span class=n>name</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>ClassNotFoundException</span> <span class=o>{</span>
                <span class=k>try</span> <span class=o>{</span>
                    <span class=n>String</span> <span class=n>fileName</span> <span class=o>=</span> <span class=n>name</span><span class=o>.</span><span class=na>substring</span><span class=o>(</span><span class=n>name</span><span class=o>.</span><span class=na>lastIndexOf</span><span class=o>(</span><span class=s>&quot;.&quot;</span><span class=o>)</span> <span class=o>+</span> <span class=mi>1</span><span class=o>)</span> <span class=o>+</span> <span class=s>&quot;.class&quot;</span><span class=o>;</span>
                    <span class=n>InputStream</span> <span class=n>is</span> <span class=o>=</span> <span class=n>getClass</span><span class=o>().</span><span class=na>getResourceAsStream</span><span class=o>(</span><span class=n>fileName</span><span class=o>);</span>
                    <span class=k>if</span> <span class=o>(</span><span class=n>is</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
                        <span class=k>return</span> <span class=kd>super</span><span class=o>.</span><span class=na>loadClass</span><span class=o>(</span><span class=n>name</span><span class=o>);</span>
                    <span class=o>}</span>
                    <span class=kt>byte</span><span class=o>[]</span> <span class=n>b</span> <span class=o>=</span> <span class=k>new</span> <span class=kt>byte</span><span class=o>[</span><span class=n>is</span><span class=o>.</span><span class=na>available</span><span class=o>()];</span>
                    <span class=n>is</span><span class=o>.</span><span class=na>read</span><span class=o>(</span><span class=n>b</span><span class=o>);</span>
                    <span class=k>return</span> <span class=n>defineClass</span><span class=o>(</span><span class=n>name</span><span class=o>,</span> <span class=n>b</span><span class=o>,</span> <span class=mi>0</span><span class=o>,</span> <span class=n>b</span><span class=o>.</span><span class=na>length</span><span class=o>);</span>
                <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>IOException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
                    <span class=k>throw</span> <span class=k>new</span> <span class=n>ClassNotFoundException</span><span class=o>(</span><span class=n>name</span><span class=o>);</span>
                <span class=o>}</span>
            <span class=o>}</span>
        <span class=o>};</span>

        <span class=n>Object</span> <span class=n>obj</span> <span class=o>=</span> <span class=n>myLoader</span><span class=o>.</span><span class=na>loadClass</span><span class=o>(</span><span class=s>&quot;com.unstandingJVM.ClassLoaderTest&quot;</span><span class=o>).</span><span class=na>newInstance</span><span class=o>();</span>

        <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=n>obj</span><span class=o>.</span><span class=na>getClass</span><span class=o>());</span>
        <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=n>obj</span> <span class=k>instanceof</span> <span class=n>com</span><span class=o>.</span><span class=na>unstandingJVM</span><span class=o>.</span><span class=na>ClassLoaderTest</span><span class=o>);</span>
    <span class=o>}</span>
<span class=o>}</span>
</pre></div></p>
<h4 id="_7">双亲委派模型<a class="headerlink" href="#_7" title="Permanent link">&para;</a></h4>
<p>从Java虚拟机的角度来讲，只存在两种不同的类加载器：⼀种是启动类加载器(Bootstrap ClassLoader)，这个类加载器使⽤C++语⾔实现 ，是虚拟机⾃⾝的⼀部分；另⼀种就是所有其他的类加载器，这些类加载器都由Java语⾔实现，独⽴于虚拟机外部，并且全都继承⾃抽象类 <C>java.lang.ClassLoader</C>。类加载器之间的这种层次关系，称为类加载器的<strong>双亲委派模型</strong>(Parents Delegation Model)</p>
<p><img alt="" src="../figures/ClassLoader.png" /></p>
<ul>
<li><strong>Bootstrap Classloader</strong>(启动类加载器) is usually implemented as native code because it is instantiated very early as the JVM is loaded. The bootstrap classloader is responsible for loading the basic Java APIs, including for example rt.jar. It only loads classes found on the boot classpath which have a higher level of trust; as a result it skips much of the validation that gets done for normal classes.</li>
<li><strong>Extension Classloader</strong>(扩展类加载器) loads classes from standard Java extension APIs such as security extension functions.</li>
<li><strong>Application Classloader</strong>(应⽤程序类加载器) is the default application classloader, which loads application classes from the classpath.</li>
<li><strong>User Defined Classloaders</strong>(⾃定义类加载器) can alternatively be used to load application classes. A user defined classloader is used for a number of special reasons including run time reloading of classes or separation between different groups of loaded classes typically required by web servers such as Tomcat.</li>
</ul>
<p>双亲委派模型的⼯作过程是：如果⼀个类加载器收到了类加载的请求，它⾸先不会⾃⼰去尝试加载这个类，⽽是把这个请求委派给⽗类加载器去完成，每⼀个层次的类加载器都是如此，因此所有的加载请求最终都应该传送到顶层的启动类加载器中，只有当⽗加载器反馈⾃⼰⽆法完成这个加载请求（它的搜索范围中没有找到所需的类）时，⼦加载器才会尝试⾃⼰去加载。</p>
<p>到了Java SE9，classloader越来越复杂，详细见<a href="https://docs.oracle.com/cd/E19501-01/819-3659/beadf/index.html">The Class Loader Hierarchy</a></p></div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="http://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script>var base_url = '../..';</script>
        <script src="../../js/base.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML"></script>
        <script src="../../extra_javascript/tabhack.js"></script>
        <script src="../../search/require.js"></script>
        <script src="../../search/search.js"></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="Search Modal" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                <h4 class="modal-title" id="exampleModalLabel">Search</h4>
            </div>
            <div class="modal-body">
                <p>
                    From here you can search these documents. Enter
                    your search terms below.
                </p>
                <form role="form">
                    <div class="form-group">
                        <input type="text" class="form-control" placeholder="Search..." id="mkdocs-search-query">
                    </div>
                </form>
                <div id="mkdocs-search-results"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="Keyboard Shortcuts Modal" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                <h4 class="modal-title" id="exampleModalLabel">Keyboard Shortcuts</h4>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td><kbd>&larr;</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td><kbd>&rarr;</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>


    </body>
</html>
